<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>组合地名生成器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* 定义CSS变量 */
        :root {
            --bg-color: #f5f5f5;
            --container-bg: white;
            --text-color: #333;
            --text-secondary: #666;
            --border-color: #e9ecef;
            --card-bg: #f8f9fa;
            --result-bg: #ecf0f1;
            --history-bg: #f8f9fa;
            --footer-bg: #f8f9fa;
            --btn-primary-bg: #3498db;
            --btn-primary-hover: #2980b9;
            --btn-success-bg: #27ae60;
            --btn-success-hover: #229954;
            --btn-danger-bg: #e74c3c;
            --btn-danger-hover: #c0392b;
            --btn-warning-bg: #f39c12;
            --btn-warning-hover: #e67e22;
            --btn-info-bg: #1abc9c;
            --btn-info-hover: #16a085;
            --btn-secondary-bg: #95a5a6;
            --btn-secondary-hover: #7f8c8d;
            --input-border: #ced4da;
            --input-focus: #3498db;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        /* 暗色模式 */
        body.dark-mode {
            --bg-color: #1a1a1a;
            --container-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #404040;
            --card-bg: #333333;
            --result-bg: #333333;
            --history-bg: #333333;
            --footer-bg: #2d2d2d;
            --btn-primary-bg: #3498db;
            --btn-primary-hover: #2980b9;
            --btn-success-bg: #27ae60;
            --btn-success-hover: #229954;
            --btn-danger-bg: #e74c3c;
            --btn-danger-hover: #c0392b;
            --btn-warning-bg: #f39c12;
            --btn-warning-hover: #e67e22;
            --btn-info-bg: #1abc9c;
            --btn-info-hover: #16a085;
            --btn-secondary-bg: #666666;
            --btn-secondary-hover: #777777;
            --input-border: #555555;
            --input-focus: #3498db;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: var(--container-bg);
            border-radius: 10px;
            box-shadow: var(--shadow);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 15px;
            }
            
            h1 {
                font-size: 24px;
                margin-bottom: 20px;
            }
            
            .button-container {
                flex-direction: column;
                align-items: center;
            }
            
            .button-container button {
                width: 100%;
                max-width: 300px;
                height: 48px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 16px;
                font-family: 'Arial', sans-serif;
                font-weight: 500;
            }
            
            .character-settings-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px !important;
            }
            
            .character-settings-header > div {
                width: 100%;
            }
            
            .character-input-item {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .character-input-item label {
                flex: 0 0 100%;
                margin-bottom: 5px;
            }
            
            .character-input-item input:not([type="checkbox"]):not([type="radio"]) {
                flex: 1;
                min-width: 150px;
            }
            
            /* 词库选择容器在小屏幕上的样式 */
            .character-input-item #library-select-0,
            .character-input-item #library-select-1,
            .character-input-item #library-select-2,
            .character-input-item #library-select-3,
            .character-input-item #library-select-4 {
                width: 100%;
            }
            
            /* 词库复选框容器在小屏幕上的样式 */
            .character-input-item #library-select-0 > div,
            .character-input-item #library-select-1 > div,
            .character-input-item #library-select-2 > div,
            .character-input-item #library-select-3 > div,
            .character-input-item #library-select-4 > div {
                margin-right: 15px;
                margin-bottom: 5px;
            }
            
            .library-btn {
                padding: 6px 12px;
                font-size: 12px;
                margin: 0 5px 5px 0;
            }
            
            .lock-status {
                margin: 5px 0;
            }
        }
        
        h1 {
            text-align: center;
            color: var(--text-color);
            margin-bottom: 30px;
            transition: color 0.3s ease;
        }
        
        p {
            text-align: center;
            margin-bottom: 30px;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        
        .result-container {
            margin-top: 30px;
            padding: 20px;
            background-color: var(--result-bg);
            border-radius: 5px;
            min-height: 100px;
            transition: background-color 0.3s ease;
        }
        
        #result {
            font-size: 24px;
            text-align: center;
            color: var(--text-color);
            font-weight: bold;
            transition: color 0.3s ease;
        }
        
        .status {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        
        .button-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }
        
        /* 统一按钮样式 */
        .btn {
            border: none;
            padding: 10px 18px;
            font-size: 16px;
            font-family: 'Arial', sans-serif;
            font-weight: 500;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        /* 主按钮 */
        .btn-primary {
            background-color: var(--btn-primary-bg);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--btn-primary-hover);
        }
        
        /* 成功按钮 */
        .btn-success {
            background-color: var(--btn-success-bg);
            color: white;
        }
        
        .btn-success:hover {
            background-color: var(--btn-success-hover);
        }
        
        /* 危险按钮 */
        .btn-danger {
            background-color: var(--btn-danger-bg);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: var(--btn-danger-hover);
        }
        
        /* 警告按钮 */
        .btn-warning {
            background-color: var(--btn-warning-bg);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: var(--btn-warning-hover);
        }
        
        /* 信息按钮 */
        .btn-info {
            background-color: var(--btn-info-bg);
            color: white;
        }
        
        .btn-info:hover {
            background-color: var(--btn-info-hover);
        }
        
        /* 次要按钮 */
        .btn-secondary {
            background-color: var(--btn-secondary-bg);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: var(--btn-secondary-hover);
        }
        
        /* 统一表单元素样式 */
        input:not([type="checkbox"]):not([type="radio"]), select, textarea {
            padding: 10px 14px;
            border: 1px solid var(--input-border);
            border-radius: 5px;
            font-size: 14px;
            background-color: var(--container-bg);
            color: var(--text-color);
            transition: border-color 0.3s ease, background-color 0.3s ease, color 0.3s ease;
        }
        
        /* 复选框和单选框样式 */
        input[type="checkbox"], input[type="radio"] {
            margin: 0;
            padding: 0;
            border: 1px solid var(--input-border);
            border-radius: 3px;
            transition: border-color 0.3s ease;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--input-focus);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.25);
        }
        
        /* 下拉框和滑动条的焦点样式 */
        select:focus, input[type="range"]:focus {
            outline: none;
            border-color: var(--input-border);
            box-shadow: none;
        }
        

        
        .history-container {
            margin-top: 30px;
            padding: 20px;
            background-color: var(--history-bg);
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        
        .history-container h3 {
            margin-bottom: 10px;
            color: var(--text-color);
            transition: color 0.3s ease;
        }
        
        #history {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .history-item {
            background-color: var(--border-color);
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 14px;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .history-item:hover {
            background-color: var(--btn-secondary-bg);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }
        
        .settings-container {
            margin-top: 20px;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        
        .settings-container h3 {
            margin-bottom: 15px;
            color: var(--text-color);
            transition: color 0.3s ease;
        }
        
        .setting-item {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .setting-item label {
            display: inline-block;
            width: 100px;
            font-weight: 500;
            color: var(--text-color);
            flex-shrink: 0;
            transition: color 0.3s ease;
        }
        
        .setting-item select {
            flex: 1;
            min-width: 150px;
        }


        
        .character-settings-container {
            margin-top: 20px;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        
        .character-settings-container h3 {
            margin-bottom: 15px;
            color: var(--text-color);
            transition: color 0.3s ease;
        }
        
        .character-input-group {
            margin-bottom: 15px;
            padding: 15px;
            background-color: var(--container-bg);
            border-radius: 5px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .character-input-group h4 {
            margin-bottom: 10px;
            color: var(--text-color);
            font-size: 14px;
            transition: color 0.3s ease;
        }
        
        .character-input-item {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .character-input-item label {
            display: inline-block;
            width: 80px;
            font-size: 14px;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        
        .character-input-item input {
            flex: 1;
        }
        
        .character-input-item select {
            flex: 1;
        }
        
        .character-input-item .lock-container {
            margin-left: 10px;
            display: flex;
            align-items: center;
        }
        
        .character-input-item .lock-checkbox {
            margin-right: 5px;
            transform: scale(1.2);
        }
        
        .character-input-item .library-btn {
            margin-left: 10px;
            padding: 8px 14px;
            background-color: var(--btn-success-bg);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .character-input-item .library-btn:hover {
            background-color: var(--btn-success-hover);
            transform: translateY(-1px);
        }
        
        .lock-status {
            margin-left: 10px;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 4px;
            background-color: var(--border-color);
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }
        
        .lock-status.locked {
            background-color: var(--btn-success-bg);
            color: white;
        }
        
        .generate-count-setting {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
        }
        
        .generate-count-setting label {
            flex: 0 0 100%;
            margin-bottom: 10px;
        }
        
        .generate-count-setting .slider-container {
            flex: 1;
            min-width: 200px;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        .slider-container input[type="range"] {
            flex: 1;
            margin: 0 10px;
        }
        
        .slider-container span {
            width: 40px;
            text-align: center;
            font-weight: 500;
            color: var(--text-color);
            transition: color 0.3s ease;
        }
        
        /* 词库管理弹窗样式 */
        .library-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .library-modal-content {
            background-color: var(--container-bg);
            margin: 10% auto;
            padding: 15px;
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 10px;
            box-shadow: var(--shadow);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        /* 手机模式下的词库管理样式 */
        @media (max-width: 768px) {
            .library-modal-content {
                margin: 5% auto;
                width: 95%;
                max-height: 90vh;
                padding: 10px;
            }
            
            .library-panel {
                gap: 10px;
            }
            
            .library-section {
                padding: 10px;
            }
            
            .library-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .library-actions button {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .library-textarea {
                height: 200px !important;
            }
        }
        
        .library-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .library-modal-header h3 {
            margin: 0;
            color: var(--text-color);
            transition: color 0.3s ease;
        }
        
        .library-content {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .char-item {
            display: inline-block;
            padding: 8px 12px;
            margin: 5px;
            background-color: var(--border-color);
            color: var(--text-color);
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .char-item:hover {
            background-color: var(--btn-secondary-bg);
        }
        
        .char-item.active {
            background-color: var(--btn-primary-bg);
            color: white;
        }
        
        .library-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .library-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .library-section {
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        
        .library-section h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--text-color);
            transition: color 0.3s ease;
        }
        
        .library-textarea {
            width: 100%;
            height: 350px;
            padding: 12px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            line-height: 1.2;
            resize: vertical;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-y: auto;
            background-color: var(--container-bg);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        
        .library-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* 隐藏的文件输入 */
        #file-input {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>组合地名生成器</h1>
        <p>使用本地中文地名用词库，随机组合生成全新的地名</p>
        
        <!-- 字符设置区域 -->
        <div class="character-settings-container">
            <h3>字符设置</h3>
            <div class="character-settings-header" style="display: flex; gap: 20px; align-items: center; margin-bottom: 20px; flex-wrap: wrap; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label for="name-length">组合部分数量：</label>
                    <select id="name-length" onchange="updateCharacterInputs()" style="padding: 8px 12px; font-size: 14px; min-width: 100px;">
                        <option value="1">1部分</option>
                        <option value="2">2部分</option>
                        <option value="3" selected>3部分</option>
                        <option value="4">4部分</option>
                        <option value="5">5部分</option>
                    </select>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label>词库管理：</label>
                        <button type="button" onclick="openLibraryManagement()" class="btn btn-primary">打开词库管理</button>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <button type="button" onclick="clearAllCustomChars()" class="btn btn-danger">清空所有自定义字符</button>
                    </div>
                </div>
            </div>
            <div id="character-inputs">
                <!-- 动态生成的字符输入框 -->
            </div>
        </div>
        
        <!-- 生成设置和按钮 -->
        <div class="settings-container">
            <h3>生成设置</h3>
            <div class="setting-item generate-count-setting">
                <label for="generate-count">生成数量：</label>
                <div class="slider-container">
                    <input type="range" id="generate-count" min="1" max="20" value="5" oninput="updateGenerateCount()">
                    <span id="generate-count-value">5</span>
                </div>
            </div>
            <div class="button-container" style="margin-top: 15px;">
                <button id="generate-btn" onclick="generatePlaceName()" class="btn btn-primary">生成单个地名</button>
                <button id="generate-multiple-btn" onclick="generateMultiplePlaceNames()" class="btn btn-primary">生成多个地名 (<span id="btn-count">5</span>个)</button>
                <button id="copy-btn" onclick="copyToClipboard()" class="btn btn-primary">复制结果</button>
            </div>
        </div>
        
        <div class="result-container">
            <div id="result">点击上方按钮生成地名</div>
        </div>
        
        <div class="history-container">
            <h3>生成历史</h3>
            <div id="history"></div>
        </div>
        
        <div class="status" id="status">就绪</div>
    </div>
    
    <script>
        // 地名用词库 - 层级结构：单字、双字、三字词
        let placeNameChars = {
                '单字': {
                    '形容': ['大', '小', '高', '低', '长', '短', '宽', '窄', '深', '浅', '远', '近', '新', '旧', '古', '老', '寒', '暖', '温', '凉', '干', '湿', '广', '阔', '明', '秀', '美', '丽', '奇', '险', '幽', '静', '惠', '优', '定', '镇', '抚', '绥', '靖', '清', '浊', '浑', '淳', '澄', '潋', '潺', '潇', '漾', '沁', '沛', '澜', '潮', '汐', '漪'],
                    '方位': ['东', '南', '西', '北', '中', '前', '后', '左', '右', '上', '下', '内', '外', '里', '间', '阳', '阴', '头', '尾'],
                    '祥瑞': ['福', '禄', '寿', '喜', '庆', '祥', '瑞', '吉', '亨', '元', '贞', '安', '宁', '和', '平', '康', '泰', '盛', '兴', '隆', '昌', '茂', '丰', '盈', '裕', '富', '贵', '荣', '华', '祺', '禛', '禕', '禧', '禄', '禟', '禠', '嘉', '美', '善', '良', '顺', '通', '达', '成', '德', '仁', '义', '礼', '智', '信', '佑', '庇', '荫', '袒', '熙', '昶', '旿', '晏', '晟', '晊', '晞', '暾', '晔', '煜', '熙', '熠', '炜', '焕', '祯', '祉', '祜', '祺', '禛', '禕', '禧', '禄', '禟', '禠', '禜', '禝'],
                    '水体': ['水', '江', '河', '湖', '海', '洋', '溪', '涧', '泉', '潭', '池', '沱', '汊', '渡', '港', '湾', '洲', '滩', '沟', '渠', '塘', '泊', '源', '渚', '汀', '漕', '荡'],
                    '天象': ['日', '月', '星', '辰', '宿', '昴', '毕', '参', '井', '斗', '牛', '奎', '娄', '胃', '昴', '觜', '参', '天', '空', '宇', '宙', '宸', '极', '昊', '苍', '穹', '霄', '霭', '霓', '霞', '云', '雾', '露', '霜', '雪', '雹', '雨', '风', '雷', '电', '阳', '阴', '晷', '晖', '曦', '晓', '旦', '昏', '暮', '夕', '朝', '晴', '昳', '曛', '乾', '坤', '朗', '皎', '晦', '明', '光', '辉', '炜', '熠', '煜', '熠', '熳', '虹', '霓', '霏', '霭', '霭', '霖', '霏', '霤', '霏'],
                    '地形': ['山', '岭', '峰', '岗', '坡', '坳', '岩', '崖', '峡', '谷', '坪', '坝', '垅', '垠', '垵', '塬', '坞', '嵩', '岱', '岷', '崆', '坵', '墩', '嶂', '嵘', '岛', '礁', '洲', '洼', '壑', '墟', '沟', '盆', '尖', '顶', '底', '原', '野', '甸', '丘', '陵', '墅', '田', '圃', '圩', '墾'],
                    '姓氏': ['王', '李', '张', '刘', '陈', '杨', '赵', '黄', '周', '吴', '徐', '孙', '胡', '朱', '高', '林', '何', '郭', '马', '罗', '梁', '宋', '郑', '谢', '韩', '唐', '冯', '于', '董', '萧', '程', '曹', '袁', '邓', '许', '傅', '沈', '曾', '彭', '吕', '苏', '华', '蒋', '蔡', '贾', '丁', '魏', '薛', '叶', '阎', '余', '潘', '杜', '戴', '夏', '锺', '汪', '田', '任', '姜', '范', '方', '石', '姚', '谭', '廖', '邹', '熊', '金', '陆', '郝', '孔', '白', '崔', '康', '毛', '邱', '秦', '江', '史', '顾', '侯', '邵', '孟', '龙', '万', '段', '雷', '钱', '汤', '尹', '黎', '易', '常', '武', '乔', '贺', '赖', '龚', '文', '庞', '樊', '兰', '殷', '施', '陶', '洪', '翟', '安', '颜', '倪', '严', '牛', '温', '芦', '季', '俞', '章', '鲁', '葛', '伍', '韦', '申', '尤', '毕', '聂', '丛', '左', '柳', '乔', '祝', '邬', '贺', '靳', '苗', '芮', '禹', '瞿', '桑', '桂', '濮', '牛', '寇', '甘', '邢', '滑', '裴', '陆', '荣', '荀', '羊', '於', '惠', '甄', '麴', '家', '封', '芮', '奚', '管', '池', '乔', '蒯', '相', '查', '后', '荆', '红', '游', '竺', '权', '逯', '盖', '益', '桓', '公'],
                    '颜色': ['红', '橙', '黄', '绿', '青', '蓝', '靛', '紫', '粉', '黑', '白', '丹', '朱', '玄', '苍', '素', '绛', '碧', '赤', '皓'],
                    '区划': ['州', '郡', '府', '国', '省', '市', '区', '县', '镇', '乡', '村'],
                    '动物': ['龙', '虎', '豹', '狼', '豺', '狮', '象', '鹿', '麒', '麟', '鸾', '凤', '凰', '鹤', '鹰', '雁', '鸡', '鸭', '鹅', '兔', '猫', '狗', '猪', '牛', '羊', '马', '鱼', '鲤', '鲟', '鲲', '鲸', '蛇', '龟', '鳖', '蚌', '蝉', '蚕', '蚁', '蜂', '鼠'],
                    '植物': ['松', '柏', '榕', '槐', '柳', '榆', '桃', '李', '梅', '兰', '竹', '菊', '荷', '莲', '芦', '苇', '葵', '榆', '桑', '棉', '麻', '榴', '樟', '桂', '榕', '枫', '榄', '枣', '楠', '桐', '楸', '榉', '菱', '茅', '荻'],
                    '矿产': ['金', '银', '铜', '铁', '锡', '铅', '汞', '煤', '炭', '石', '玉', '珠', '宝', '砂', '砾', '琥', '珊', '沙', '珍', '琅', '琦', '琛', '琰'],
                    '建筑': ['桥', '塔', '楼', '台', '亭', '阁', '关', '城', '堡', '墙', '门', '户', '院', '寺', '庙', '观', '坛', '庵', '堂', '宫', '殿', '院', '坞', '堤', '坝', '闸', '渡', '集', '圩', '场', '屯', '堡', '寨', '营', '哨', '墅', '驿', '站', '坊', '墟', '墩', '仓'],
                    '省份': ['京', '津', '冀', '晋', '蒙', '辽', '吉', '黑', '沪', '苏', '浙', '皖', '闽', '赣', '鲁', '豫', '鄂', '湘', '粤', '桂', '琼', '渝', '川', '贵', '云', '藏', '陕', '甘', '青', '宁', '新', '港', '澳', '台'],
                    '道路': ['道', '路', '坊', '里', '巷', '街'],
                    '数字': ['一', '二', '三', '四', '五', '六', '七', '八', '九', '十', '百', '千', '万', '亿', '兆', '单', '双']
                },
                '词汇': {
                    '城市': ['北京','天津','石家庄','唐山','秦皇岛','邯郸','邢台','保定','张家口','承德','沧州','廊坊','衡水','太原','大同','阳泉','长治','晋城','朔州','晋中','运城','忻州','临汾','吕梁','呼和浩特','包头','乌海','赤峰','通辽','鄂尔多斯','呼伦贝尔','巴彦淖尔','乌兰察布','兴安','阿拉善','沈阳','大连','鞍山','抚顺','本溪','丹东','锦州','营口','阜新','辽阳','盘锦','铁岭','朝阳','葫芦岛','长春','吉林','四平','辽源','通化','白山','松原','白城','延边','哈尔滨','齐齐哈尔','鸡西','鹤岗','双鸭山','大庆','伊春','佳木斯','七台河','牡丹江','黑河','绥化','大兴安岭','上海','南京','无锡','徐州','常州','苏州','南通','连云港','淮安','盐城','扬州','镇江','泰州','宿迁','杭州','宁波','温州','嘉兴','湖州','绍兴','金华','衢州','舟山','台州','丽水','合肥','芜湖','蚌埠','淮南','马鞍山','淮北','铜陵','安庆','黄山','滁州','阜阳','宿州','六安','亳州','池州','宣城','福州','厦门','莆田','三明','泉州','漳州','南平','龙岩','宁德','南昌','景德镇','萍乡','九江','新余','鹰潭','赣州','吉安','宜春','抚州','上饶','济南','青岛','淄博','枣庄','东营','烟台','潍坊','济宁','泰安','威海','日照','临沂','德州','聊城','滨州','菏泽','郑州','开封','洛阳','平顶山','安阳','鹤壁','新乡','焦作','濮阳','许昌','漯河','三门峡','南阳','商丘','信阳','周口','驻马店','济源','武汉','黄石','十堰','宜昌','襄阳','鄂州','荆门','孝感','荆州','黄冈','咸宁','随州','恩施','仙桃','潜江','天门','神农架','长沙','株洲','湘潭','衡阳','邵阳','岳阳','常德','张家界','益阳','郴州','永州','怀化','娄底','湘西','广州','韶关','深圳','珠海','汕头','佛山','江门','湛江','茂名','肇庆','惠州','梅州','汕尾','河源','阳江','清远','东莞','中山','潮州','揭阳','云浮','南宁','柳州','桂林','梧州','北海','防城港','钦州','贵港','玉林','百色','贺州','河池','来宾','崇左','海口','三亚','三沙','儋州','五指山','琼海','文昌','万宁','东方','定安','屯昌','澄迈','临高','白沙','昌江','乐东','陵水','保亭','琼中','成都','自贡','攀枝花','泸州','德阳','绵阳','广元','遂宁','内江','乐山','南充','眉山','宜宾','广安','达州','雅安','巴中','资阳','阿坝','甘孜','凉山','贵阳','六盘水','遵义','安顺','毕节','铜仁','黔西南','黔东南','黔南','昆明','曲靖','玉溪','保山','昭通','丽江','普洱','临沧','楚雄','红河','文山','西双版纳','大理','德宏','怒江','迪庆','拉萨','日喀则','昌都','林芝','山南','那曲','阿里','西安','铜川','宝鸡','咸阳','渭南','延安','汉中','榆林','安康','商洛','兰州','嘉峪关','金昌','白银','天水','武威','张掖','平凉','酒泉','庆阳','定西','陇南','临夏','甘南','西宁','海东','海北','黄南','海南','果洛','玉树','海西','银川','石嘴山','吴忠','固原','中卫','乌鲁木齐','克拉玛依','吐鲁番','哈密','昌吉','博尔塔拉','巴音郭楞','阿克苏','克孜勒苏','喀什','和田','伊犁','塔城','阿勒泰','石河子','阿拉尔','图木舒克','五家渠','北屯','铁门关','双河','可克达拉','昆玉','胡杨河','新星','呼和浩特','包头','乌海','赤峰','通辽','鄂尔多斯','呼伦贝尔','巴彦淖尔','乌兰察布','兴安','阿拉善','香港','澳门','台北','新北','桃园','台中','台南','高雄','基隆','新竹','嘉义'],                   '省份': ['北京','天津','河北','山西','内蒙古','辽宁','吉林','黑龙江','上海','江苏','浙江','安徽','福建','江西','山东','河南','湖北','湖南','广东','广西','海南','重庆','四川','贵州','云南','西藏','陕西','甘肃','青海','宁夏','新疆','香港','澳门','台湾'],
                    '河流': ['长江','黄河','珠江','黑龙江','松花江','淮河','海河','辽河','澜沧江','怒江','雅鲁藏布江','汉江','嘉陵江','岷江','乌江','湘江','赣江','闽江','钱塘江','瓯江','大渡河','沱江','涪江','渭河','汾河','蓟运河','永定河','潮白河','北运河','南运河','红水河','柳江','郁江','桂江','西江','北江','东江','韩江','九龙江','晋江','瓯江','椒江','甬江','苕溪','新安江','富春江','信江','抚河','修水','清江','酉水','澧水','资水','沅江','白龙江','洮河','湟水','伊洛河','沁河','漳河','卫河','滹沱河','桑干河','大凌河','小凌河','鸭绿江','图们江','绥芬河','额尔齐斯河','塔里木河','叶尔羌河','和田河','阿克苏河','开都河','孔雀河','车尔臣河','疏勒河','黑河','石羊河','无定河','窟野河','秃尾河','延河','洛河','丹江','唐河','白河','沙颍河','涡河','浍河','洪泽湖入江水道','通扬运河','苏北灌溉总渠'],
                    '山脉': ['泰山','华山','衡山','恒山','嵩山','黄山','庐山','峨眉山','普陀山','九华山','五台山','武夷山','长白山','天山','昆仑山','喜马拉雅山','横断山','秦岭','大兴安岭','太行山','巫山','武陵山','雪峰山','南岭','阴山','贺兰山','祁连山','六盘山','大巴山','大别山','井冈山','雁荡山','武当山','青城山','龙虎山','齐云山','三清山','莫干山','天目山','四明山','会稽山','崂山','蓬莱山','沂蒙山','五莲山','云台山','王屋山','老君山','鸡公山','伏牛山','神农架','梵净山','哀牢山','无量山','高黎贡山','怒山','沙鲁里山','邛崃山','岷山','唐古拉山','念青唐古拉山','冈底斯山','喀喇昆仑山','阿尔泰山','准噶尔阿拉套山','桐柏山','罗霄山','幕阜山','九岭山','武功山','大庾岭','骑田岭','都庞岭','越城岭','萌渚岭','五指山','黎母山','吊罗山','尖峰岭','霸王岭','七仙岭','东山','西山','北固山','金山','焦山','圌山','花果山','云龙山','微山','峄山','蒙山','徂徕山','梁山','昆嵛山','牙山','艾山','招虎山','鹤山','浮山','大泽山','茶山','盘山','雾灵山','小五台山','百花山','东灵山','西灵山','海坨山','军都山','燕山'],
                    '湖泊': ['鄱阳湖','洞庭湖','太湖','洪泽湖','巢湖','青海湖','滇池','洱海','抚仙湖','泸沽湖','纳木错','色林错','羊卓雍措','博斯腾湖','兴凯湖','呼伦湖','贝尔湖','乌梁素海','岱海','达里诺尔湖','镜泊湖','五大连池','长白山天池','天山天池','赛里木湖','艾比湖','博湖','阿克塞钦湖','班公错','玛旁雍错','拉昂错','扎日南木错','当惹雍错','鄂陵湖','扎陵湖','微山湖','骆马湖','高邮湖','洪湖','梁子湖','汈汊湖','斧头湖','汈东湖','武昌湖','升金湖','菜子湖','龙感湖','大官湖','黄湖','泊湖','石臼湖','固城湖','滆湖','长荡湖','阳澄湖','淀山湖','澄湖','独山湖','南阳湖','昭阳湖','微山湖','骆马湖','洪泽湖','高邮湖','宝应湖','白马湖','邵伯湖','滆湖','长荡湖','太湖','阳澄湖','淀山湖','澄湖','昆承湖','尚湖','元荡','汾湖','沐阳湖','得胜湖','大纵湖','射阳湖','蜈蚣湖','刁汊湖','汈汊湖','府澴河湖群','汈东湖','武昌湖','升金湖','菜子湖','龙感湖','大官湖','黄湖','泊湖','石臼湖','固城湖','南漪湖','女山湖','七里湖','瓦埠湖','城东湖','城西湖','焦岗湖','高塘湖','花园湖','沂湖','洋湖','白荡湖','枫沙湖','陈瑶湖','白兔湖','嬉子湖','双井湖','汤湖','黄陂湖','清水湖','竹丝湖','黑沙湖','谷湖','小七孔湖','万峰湖','红枫湖','百花湖','草海','威宁草海','异龙湖','杞麓湖','星云湖','程海','阳宗海','碧塔海','属都湖','拉市海','巴松措','然乌湖','玛纳斯湖','艾丁湖','罗布泊','台特玛湖','哈拉奇','居延海','月亮湖','达格图湖','查干诺尔','查干淖尔','乌兰淖尔','吉兰泰盐湖','茶卡盐湖','察尔汗盐湖','大柴旦湖','小柴旦湖','可鲁克湖','托素湖','苏干湖','尕海','花湖','若尔盖湖','黄河首曲湿地湖泊群','扎日南木错','当穹错','昂拉仁错','塔若错','扎布耶茶卡','许如错','普莫雍错','哲古错','错那','错鄂','雅根错','邦达错','多庆错','佩枯错','公珠错','玛尔果茶卡','洞错','隆觉错','仓木错','打加错','昂孜错','戈芒错','扎日南木错','扎布耶茶卡','许如错','普莫雍错','哲古错','错那','错鄂','雅根错','邦达错','多庆错','佩枯错','公珠错','玛尔果茶卡','洞错','隆觉错','仓木错','打加错','昂孜错','戈芒错'],
                    '岛屿': ['台湾岛','海南岛','崇明岛','舟山岛','海坛岛','东海岛','长兴岛','东山岛','玉环岛','大屿山','横沙岛','长兴沙','灵山岛','庙岛','南日岛','万山群岛','上川岛','下川岛','南澳岛','涠洲岛','斜阳岛','硇洲岛','东海岛','兰屿','绿岛','钓鱼岛','黄尾屿','赤尾屿','南小岛','北小岛','棉花屿','花瓶屿','彭佳屿','基隆屿','龟山岛','小琉球','七星岩','太平岛','中业岛','南威岛','弹丸礁','曾母暗沙','永兴岛','七连屿','赵述岛','北岛','中岛','南岛','东岛','西沙洲','中沙洲','南沙洲','银屿','石岛','珊瑚岛','甘泉岛','晋卿岛','琛航岛','广金岛','羚羊礁','全富岛','鸭公岛','咸舍屿','银屿仔','筐仔沙洲','北礁','浪花礁','雄南礁','立地暗沙','八仙暗沙','隐矶滩','欢乐暗沙','舰长暗沙','海马滩','半月礁','司令礁','无乜礁','南屏礁','舶兰礁','安塘礁','道明群礁','双黄沙洲','南钥岛','杨信沙洲','库归礁','法礁','铁线礁','都护暗沙','指掌暗沙','永暑礁','美济岛','仁爱礁','五方礁','信义礁','礼乐滩','安塘滩','榆亚暗沙','二角礁','簸箕礁','光星礁','光星仔礁','息波礁','南海礁','海康暗沙','海安礁','盟谊暗沙','李准滩','西卫滩','万安滩','水暑礁','金盾暗沙','奥南暗沙','南华礁','六门礁','石盘仔','毕生礁','榆亚暗沙','安渡滩','舶兰礁','染青沙洲','景宏岛','鸿庥岛','南薰礁','东门礁','赤瓜礁','鬼喊礁','琼礁','广雅滩','人骏滩','李准滩','西卫滩','万安滩','水暑礁','金盾暗沙','奥南暗沙','南华礁','六门礁','石盘仔','毕生礁','榆亚暗沙','安渡滩','舶兰礁','染青沙洲','景宏岛','鸿庥岛','南薰礁','东门礁','赤瓜礁','鬼喊礁','琼礁','广雅滩','人骏滩','雄南礁','立地暗沙','八仙暗沙','隐矶滩','欢乐暗沙','舰长暗沙','海马滩','半月礁','司令礁','无乜礁','南屏礁','舶兰礁','安塘礁','道明群礁','双黄沙洲','南钥岛','杨信沙洲','库归礁','法礁','铁线礁','都护暗沙','指掌暗沙','永暑礁','美济岛','仁爱礁','五方礁','信义礁','礼乐滩','安塘滩','榆亚暗沙','二角礁','簸箕礁','光星礁','光星仔礁','息波礁','南海礁','海康暗沙','海安礁','盟谊暗沙','李准滩','西卫滩','万安滩','水暑礁','金盾暗沙','奥南暗沙','南华礁','六门礁','石盘仔','毕生礁','榆亚暗沙','安渡滩','舶兰礁','染青沙洲','景宏岛','鸿庥岛','南薰礁','东门礁','赤瓜礁','鬼喊礁','琼礁','广雅滩','人骏滩','雄南礁','立地暗沙','八仙暗沙','隐矶滩','欢乐暗沙','舰长暗沙','海马滩','半月礁','司令礁','无乜礁','南屏礁','舶兰礁','安塘礁','道明群礁','双黄沙洲','南钥岛','杨信沙洲','库归礁','法礁','铁线礁','都护暗沙','指掌暗沙','永暑礁','美济岛','仁爱礁','五方礁','信义礁','礼乐滩','安塘滩','榆亚暗沙','二角礁','簸箕礁','光星礁','光星仔礁','息波礁','南海礁','海康暗沙','海安礁','盟谊暗沙','李准滩','西卫滩','万安滩','水暑礁','金盾暗沙','奥南暗沙','南华礁','六门礁','石盘仔','毕生礁','榆亚暗沙','安渡滩','舶兰礁','染青沙洲','景宏岛','鸿庥岛','南薰礁','东门礁','赤瓜礁','鬼喊礁','琼礁','广雅滩','人骏滩'],
                    '红色': ['解放', '光明', '新生', '崭新', '奋进', '复兴', '振兴', '自强', '自立', '自由', '和平', '安宁', '团结', '进步', '发展', '富强', '民主', '文明', '和谐', '繁荣', '昌盛', '兴隆', '腾飞', '飞跃', '崛起', '朝阳', '旭日', '曙光', '晨曦', '春晖', '红旗', '东方', '红星', '丹心', '赤诚', '先锋', '先烈', '英雄', '志士', '仁人', '康庄', '大道', '宏图', '伟业', '鸿猷', '清源', '正气', '浩然', '崇德', '向善', '启明', '开明', '启航', '扬帆', '远征', '惠民', '利民', '为民', '安民', '乐业', '锦绣', '锦程', '华章', '盛世', '清平']
                }
        };
        
        // 初始化地名用词库
        function initPlaceNameChars() {
            try {
                document.getElementById('status').textContent = '初始化地名用词库...';
                document.getElementById('generate-btn').disabled = true;
                
                // 首先尝试从本地存储加载词库
                const savedLibraries = localStorage.getItem('placeNameChars');
                if (savedLibraries) {
                    try {
                        placeNameChars = JSON.parse(savedLibraries);
                        console.log('从本地存储加载词库成功');
                    } catch (e) {
                        console.error('解析本地存储的词库失败:', e);
                        // 解析失败时使用默认词库
                    }
                }
                
                setTimeout(() => {
                    // 计算总字数
                    let totalChars = 0;
                    Object.values(placeNameChars).forEach(category => {
                        Object.values(category).forEach(array => {
                            totalChars += array.length;
                        });
                    });
                    
                    document.getElementById('status').textContent = `地名用词库初始化完成 (共 ${totalChars} 个用字)`;
                    document.getElementById('generate-btn').disabled = false;
                }, 500);
            } catch (error) {
                console.error('初始化地名用词库失败:', error);
                document.getElementById('status').textContent = '初始化地名用词库失败';
                document.getElementById('generate-btn').disabled = false;
            }
        }
        
        // 保存词库到本地存储
        function saveLibrariesToLocalStorage() {
            try {
                localStorage.setItem('placeNameChars', JSON.stringify(placeNameChars));
                console.log('词库已保存到本地存储');
            } catch (error) {
                console.error('保存词库到本地存储失败:', error);
            }
        }
        
        // 新增词库类型
        function addNewType() {
            const typeName = prompt('请输入新词库类型名称：');
            if (!typeName) return;
            
            if (!placeNameChars[typeName]) {
                placeNameChars[typeName] = {};
                // 保存到本地存储
                saveLibrariesToLocalStorage();
                // 重新初始化词库类型选择
                initTypeSelect();
                // 重新初始化词库选择下拉框
                initLibrarySelect();
                alert(`新词库类型 "${typeName}" 已添加`);
            } else {
                alert('词库类型名称已存在');
            }
        }
        
        // 重命名词库类型
        function renameType() {
            const typeSelectElement = document.getElementById('type-select');
            if (!typeSelectElement) return;
            
            const oldTypeName = typeSelectElement.value;
            if (!oldTypeName) return;
            
            const newTypeName = prompt('请输入新词库类型名称：', oldTypeName);
            if (!newTypeName || newTypeName === oldTypeName) return;
            
            if (!placeNameChars[newTypeName]) {
                // 创建新类型并复制旧类型的词库
                placeNameChars[newTypeName] = {...placeNameChars[oldTypeName]};
                // 删除旧类型
                delete placeNameChars[oldTypeName];
                // 保存到本地存储
                saveLibrariesToLocalStorage();
                // 重新初始化词库类型选择
                initTypeSelect();
                // 重新初始化词库选择下拉框
                initLibrarySelect();
                alert(`词库类型已重命名为 "${newTypeName}"`);
            } else {
                alert('新词库类型名称已存在');
            }
        }
        
        // 删除词库类型
        function deleteType() {
            const typeSelectElement = document.getElementById('type-select');
            if (!typeSelectElement) return;
            
            const selectedType = typeSelectElement.value;
            if (!selectedType || !placeNameChars[selectedType]) return;
            
            // 确认删除，特别是当该类型下有词库时
            const libraries = placeNameChars[selectedType];
            const libraryCount = libraries ? Object.keys(libraries).length : 0;
            let confirmMessage = `确定要删除词库类型 "${selectedType}" 吗？`;
            if (libraryCount > 0) {
                confirmMessage += `\n该类型下有 ${libraryCount} 个词库，删除类型后这些词库将被移动到"未分类"类型。`;
            }
            
            if (confirm(confirmMessage)) {
                // 确保"未分类"类型存在
                if (!placeNameChars['未分类']) {
                    placeNameChars['未分类'] = {};
                }
                
                // 将该类型下的词库移动到"未分类"类型
                if (libraries && typeof libraries === 'object') {
                    Object.keys(libraries).forEach(libraryName => {
                        placeNameChars['未分类'][libraryName] = [...libraries[libraryName]];
                    });
                }
                
                // 删除词库类型
                delete placeNameChars[selectedType];
                // 保存到本地存储
                saveLibrariesToLocalStorage();
                // 重新初始化词库类型选择
                initTypeSelect();
                // 重新初始化词库选择下拉框
                initLibrarySelect();
                alert(`词库类型 "${selectedType}" 已删除，其中的词库已移动到"未分类"类型。`);
            }
        }
        
        // 显示添加词库到类型的模态框
        function showAddLibraryToTypeModal() {
            const typeSelectElement = document.getElementById('type-select');
            if (!typeSelectElement) return;
            
            const selectedType = typeSelectElement.value;
            if (!selectedType) {
                alert('请先选择一个词库类型');
                return;
            }
            
            // 创建模态框
            let modal = document.getElementById('add-library-to-type-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'add-library-to-type-modal';
                modal.className = 'library-modal';
                document.body.appendChild(modal);
            }
            
            // 收集所有可添加的词库（不在当前类型中的词库）
            const availableLibraries = [];
            Object.keys(placeNameChars).forEach(type => {
                if (type === selectedType) return; // 跳过当前类型
                
                Object.keys(placeNameChars[type]).forEach(libraryName => {
                    // 检查该词库是否已在目标类型中存在
                    if (!placeNameChars[selectedType][libraryName]) {
                        availableLibraries.push({ type, name: libraryName });
                    }
                });
            });
            
            if (availableLibraries.length === 0) {
                alert('没有可添加的词库');
                return;
            }
            
            // 生成词库选择界面
            let checkboxesHTML = '';
            availableLibraries.forEach(library => {
                checkboxesHTML += `
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <input type="checkbox" id="add-lib-${library.type}-${library.name}" value="${library.type}/${library.name}" style="transform: scale(1.2); margin-right: 10px;">
                        <label for="add-lib-${library.type}-${library.name}" style="font-size: 14px; cursor: pointer;">${library.type} / ${library.name}</label>
                    </div>
                `;
            });
            
            modal.innerHTML = `
                <div class="library-modal-content" style="max-width: 500px;">
                    <div class="library-modal-header">
                        <h3>添加词库到 ${selectedType}</h3>
                        <button class="btn btn-secondary" onclick="closeAddLibraryToTypeModal()" style="font-size: 24px; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">&times;</button>
                    </div>
                    <div style="max-height: 450px; overflow-y: auto; border-radius: 5px; border: 1px solid var(--border-color); background-color: var(--card-bg);">
                        <div style="padding: 15px; position: sticky; top: 0; background-color: var(--card-bg); border-bottom: 1px solid var(--border-color); z-index: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <p style="font-size: 14px; margin: 0;">选择要添加到 ${selectedType} 的词库：</p>
                                <div style="display: flex; gap: 5px;">
                                    <button class="btn btn-primary" onclick="selectAllLibrariesInModal()" style="padding: 4px 8px; font-size: 11px;">全选</button>
                                    <button class="btn btn-warning" onclick="invertLibrariesInModal()" style="padding: 4px 8px; font-size: 11px;">反选</button>
                                    <button class="btn btn-danger" onclick="clearLibrariesInModal()" style="padding: 4px 8px; font-size: 11px;">清空</button>
                                </div>
                            </div>
                        </div>
                        <div style="padding: 15px;">
                            ${checkboxesHTML}
                        </div>
                    </div>
                    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="closeAddLibraryToTypeModal()">取消</button>
                        <button class="btn btn-primary" onclick="confirmAddLibrariesToType('${selectedType}')">确认添加</button>
                    </div>
                </div>
            `;
            
            // 显示模态框
            modal.style.display = 'block';
        }
        
        // 关闭添加词库到类型的模态框
        function closeAddLibraryToTypeModal() {
            const modal = document.getElementById('add-library-to-type-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // 确认添加词库到类型
        function confirmAddLibrariesToType(targetType) {
            const modal = document.getElementById('add-library-to-type-modal');
            if (!modal) return;
            
            // 获取选中的词库
            const checkboxes = modal.querySelectorAll('input[type="checkbox"]:checked');
            const selectedLibraries = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedLibraries.length === 0) {
                alert('请至少选择一个词库');
                return;
            }
            
            // 添加词库到目标类型
            let addedCount = 0;
            selectedLibraries.forEach(libraryPath => {
                const [sourceType, libraryName] = libraryPath.split('/');
                if (sourceType && libraryName) {
                    // 复制词库内容到目标类型
                    placeNameChars[targetType][libraryName] = [...placeNameChars[sourceType][libraryName]];
                    // 从源类型中删除词库
                    delete placeNameChars[sourceType][libraryName];
                    addedCount++;
                }
            });
            
            // 保存到本地存储
            saveLibrariesToLocalStorage();
            
            // 关闭模态框
            modal.style.display = 'none';
            
            // 重新加载词库类型列表
            changeType();
            
            // 重新初始化词库选择下拉框
            initLibrarySelect();
            
            // 显示成功消息
            alert(`成功添加 ${addedCount} 个词库到 ${targetType}`);
        }
        
        // 全选模态框中的词库
        function selectAllLibrariesInModal() {
            const modal = document.getElementById('add-library-to-type-modal');
            if (!modal) return;
            
            const checkboxes = modal.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
        }
        
        // 反选模态框中的词库
        function invertLibrariesInModal() {
            const modal = document.getElementById('add-library-to-type-modal');
            if (!modal) return;
            
            const checkboxes = modal.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = !checkbox.checked;
            });
        }
        
        // 清空模态框中的词库选择
        function clearLibrariesInModal() {
            const modal = document.getElementById('add-library-to-type-modal');
            if (!modal) return;
            
            const checkboxes = modal.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }
        
        // 恢复出厂设置（默认词库）
        function resetToDefaultLibraries() {
            // 确认用户操作
            if (!confirm('确定要恢复出厂设置吗？这将清除所有自定义词库和更改，恢复到默认词库状态。')) {
                return;
            }
            
            // 重置为默认词库数据
            placeNameChars = {
                '单字': {
                    '形容': ['大', '小', '高', '低', '长', '短', '宽', '窄', '深', '浅', '远', '近', '新', '旧', '古', '老', '寒', '暖', '温', '凉', '干', '湿', '广', '阔', '明', '秀', '美', '丽', '奇', '险', '幽', '静', '惠', '优', '定', '镇', '抚', '绥', '靖', '清', '浊', '浑', '淳', '澄', '潋', '潺', '潇', '漾', '沁', '沛', '澜', '潮', '汐', '漪'],
                    '方位': ['东', '南', '西', '北', '中', '前', '后', '左', '右', '上', '下', '内', '外', '里', '间', '阳', '阴', '头', '尾'],
                    '祥瑞': ['福', '禄', '寿', '喜', '庆', '祥', '瑞', '吉', '亨', '元', '贞', '安', '宁', '和', '平', '康', '泰', '盛', '兴', '隆', '昌', '茂', '丰', '盈', '裕', '富', '贵', '荣', '华', '祺', '禛', '禕', '禧', '禄', '禟', '禠', '嘉', '美', '善', '良', '顺', '通', '达', '成', '德', '仁', '义', '礼', '智', '信', '佑', '庇', '荫', '袒', '熙', '昶', '旿', '晏', '晟', '晊', '晞', '暾', '晔', '煜', '熙', '熠', '炜', '焕', '祯', '祉', '祜', '祺', '禛', '禕', '禧', '禄', '禟', '禠', '禜', '禝'],
                    '水体': ['水', '江', '河', '湖', '海', '洋', '溪', '涧', '泉', '潭', '池', '沱', '汊', '渡', '港', '湾', '洲', '滩', '沟', '渠', '塘', '泊', '源', '渚', '汀', '漕', '荡'],
                    '天象': ['日', '月', '星', '辰', '宿', '昴', '毕', '参', '井', '斗', '牛', '奎', '娄', '胃', '昴', '觜', '参', '天', '空', '宇', '宙', '宸', '极', '昊', '苍', '穹', '霄', '霭', '霓', '霞', '云', '雾', '露', '霜', '雪', '雹', '雨', '风', '雷', '电', '阳', '阴', '晷', '晖', '曦', '晓', '旦', '昏', '暮', '夕', '朝', '晴', '昳', '曛', '乾', '坤', '朗', '皎', '晦', '明', '光', '辉', '炜', '熠', '煜', '熠', '熳', '虹', '霓', '霏', '霭', '霭', '霖', '霏', '霤', '霏'],
                    '地形': ['山', '岭', '峰', '岗', '坡', '坳', '岩', '崖', '峡', '谷', '坪', '坝', '垅', '垠', '垵', '塬', '坞', '嵩', '岱', '岷', '崆', '坵', '墩', '嶂', '嵘', '岛', '礁', '洲', '洼', '壑', '墟', '沟', '盆', '尖', '顶', '底', '原', '野', '甸', '丘', '陵', '墅', '田', '圃', '圩', '墾'],
                    '姓氏': ['王', '李', '张', '刘', '陈', '杨', '赵', '黄', '周', '吴', '徐', '孙', '胡', '朱', '高', '林', '何', '郭', '马', '罗', '梁', '宋', '郑', '谢', '韩', '唐', '冯', '于', '董', '萧', '程', '曹', '袁', '邓', '许', '傅', '沈', '曾', '彭', '吕', '苏', '华', '蒋', '蔡', '贾', '丁', '魏', '薛', '叶', '阎', '余', '潘', '杜', '戴', '夏', '锺', '汪', '田', '任', '姜', '范', '方', '石', '姚', '谭', '廖', '邹', '熊', '金', '陆', '郝', '孔', '白', '崔', '康', '毛', '邱', '秦', '江', '史', '顾', '侯', '邵', '孟', '龙', '万', '段', '雷', '钱', '汤', '尹', '黎', '易', '常', '武', '乔', '贺', '赖', '龚', '文', '庞', '樊', '兰', '殷', '施', '陶', '洪', '翟', '安', '颜', '倪', '严', '牛', '温', '芦', '季', '俞', '章', '鲁', '葛', '伍', '韦', '申', '尤', '毕', '聂', '丛', '左', '柳', '乔', '祝', '邬', '贺', '靳', '苗', '芮', '禹', '瞿', '桑', '桂', '濮', '牛', '寇', '甘', '邢', '滑', '裴', '陆', '荣', '荀', '羊', '於', '惠', '甄', '麴', '家', '封', '芮', '奚', '管', '池', '乔', '蒯', '相', '查', '后', '荆', '红', '游', '竺', '权', '逯', '盖', '益', '桓', '公'],
                    '颜色': ['红', '橙', '黄', '绿', '青', '蓝', '靛', '紫', '粉', '黑', '白', '丹', '朱', '玄', '苍', '素', '绛', '碧', '赤', '皓'],
                    '区划': ['州', '郡', '府', '国', '省', '市', '区', '县', '镇', '乡', '村'],
                    '动物': ['龙', '虎', '豹', '狼', '豺', '狮', '象', '鹿', '麒', '麟', '鸾', '凤', '凰', '鹤', '鹰', '雁', '鸡', '鸭', '鹅', '兔', '猫', '狗', '猪', '牛', '羊', '马', '鱼', '鲤', '鲟', '鲲', '鲸', '蛇', '龟', '鳖', '蚌', '蝉', '蚕', '蚁', '蜂', '鼠'],
                    '植物': ['松', '柏', '榕', '槐', '柳', '榆', '桃', '李', '梅', '兰', '竹', '菊', '荷', '莲', '芦', '苇', '葵', '榆', '桑', '棉', '麻', '榴', '樟', '桂', '榕', '枫', '榄', '枣', '楠', '桐', '楸', '榉', '菱', '茅', '荻'],
                    '矿产': ['金', '银', '铜', '铁', '锡', '铅', '汞', '煤', '炭', '石', '玉', '珠', '宝', '砂', '砾', '琥', '珊', '沙', '珍', '琅', '琦', '琛', '琰'],
                    '建筑': ['桥', '塔', '楼', '台', '亭', '阁', '关', '城', '堡', '墙', '门', '户', '院', '寺', '庙', '观', '坛', '庵', '堂', '宫', '殿', '院', '坞', '堤', '坝', '闸', '渡', '集', '圩', '场', '屯', '堡', '寨', '营', '哨', '墅', '驿', '站', '坊', '墟', '墩', '仓'],
                    '省份': ['京', '津', '冀', '晋', '蒙', '辽', '吉', '黑', '沪', '苏', '浙', '皖', '闽', '赣', '鲁', '豫', '鄂', '湘', '粤', '桂', '琼', '渝', '川', '贵', '云', '藏', '陕', '甘', '青', '宁', '新', '港', '澳', '台'],
                    '道路': ['道', '路', '坊', '里', '巷', '街'],
                    '数字': ['一', '二', '三', '四', '五', '六', '七', '八', '九', '十', '百', '千', '万', '亿', '兆', '单', '双']
                },
                '词汇': {
                    '城市': ['北京','天津','石家庄','唐山','秦皇岛','邯郸','邢台','保定','张家口','承德','沧州','廊坊','衡水','太原','大同','阳泉','长治','晋城','朔州','晋中','运城','忻州','临汾','吕梁','呼和浩特','包头','乌海','赤峰','通辽','鄂尔多斯','呼伦贝尔','巴彦淖尔','乌兰察布','兴安','阿拉善','沈阳','大连','鞍山','抚顺','本溪','丹东','锦州','营口','阜新','辽阳','盘锦','铁岭','朝阳','葫芦岛','长春','吉林','四平','辽源','通化','白山','松原','白城','延边','哈尔滨','齐齐哈尔','鸡西','鹤岗','双鸭山','大庆','伊春','佳木斯','七台河','牡丹江','黑河','绥化','大兴安岭','上海','南京','无锡','徐州','常州','苏州','南通','连云港','淮安','盐城','扬州','镇江','泰州','宿迁','杭州','宁波','温州','嘉兴','湖州','绍兴','金华','衢州','舟山','台州','丽水','合肥','芜湖','蚌埠','淮南','马鞍山','淮北','铜陵','安庆','黄山','滁州','阜阳','宿州','六安','亳州','池州','宣城','福州','厦门','莆田','三明','泉州','漳州','南平','龙岩','宁德','南昌','景德镇','萍乡','九江','新余','鹰潭','赣州','吉安','宜春','抚州','上饶','济南','青岛','淄博','枣庄','东营','烟台','潍坊','济宁','泰安','威海','日照','临沂','德州','聊城','滨州','菏泽','郑州','开封','洛阳','平顶山','安阳','鹤壁','新乡','焦作','濮阳','许昌','漯河','三门峡','南阳','商丘','信阳','周口','驻马店','济源','武汉','黄石','十堰','宜昌','襄阳','鄂州','荆门','孝感','荆州','黄冈','咸宁','随州','恩施','仙桃','潜江','天门','神农架','长沙','株洲','湘潭','衡阳','邵阳','岳阳','常德','张家界','益阳','郴州','永州','怀化','娄底','湘西','广州','韶关','深圳','珠海','汕头','佛山','江门','湛江','茂名','肇庆','惠州','梅州','汕尾','河源','阳江','清远','东莞','中山','潮州','揭阳','云浮','南宁','柳州','桂林','梧州','北海','防城港','钦州','贵港','玉林','百色','贺州','河池','来宾','崇左','海口','三亚','三沙','儋州','五指山','琼海','文昌','万宁','东方','定安','屯昌','澄迈','临高','白沙','昌江','乐东','陵水','保亭','琼中','成都','自贡','攀枝花','泸州','德阳','绵阳','广元','遂宁','内江','乐山','南充','眉山','宜宾','广安','达州','雅安','巴中','资阳','阿坝','甘孜','凉山','贵阳','六盘水','遵义','安顺','毕节','铜仁','黔西南','黔东南','黔南','昆明','曲靖','玉溪','保山','昭通','丽江','普洱','临沧','楚雄','红河','文山','西双版纳','大理','德宏','怒江','迪庆','拉萨','日喀则','昌都','林芝','山南','那曲','阿里','西安','铜川','宝鸡','咸阳','渭南','延安','汉中','榆林','安康','商洛','兰州','嘉峪关','金昌','白银','天水','武威','张掖','平凉','酒泉','庆阳','定西','陇南','临夏','甘南','西宁','海东','海北','黄南','海南','果洛','玉树','海西','银川','石嘴山','吴忠','固原','中卫','乌鲁木齐','克拉玛依','吐鲁番','哈密','昌吉','博尔塔拉','巴音郭楞','阿克苏','克孜勒苏','喀什','和田','伊犁','塔城','阿勒泰','石河子','阿拉尔','图木舒克','五家渠','北屯','铁门关','双河','可克达拉','昆玉','胡杨河','新星','呼和浩特','包头','乌海','赤峰','通辽','鄂尔多斯','呼伦贝尔','巴彦淖尔','乌兰察布','兴安','阿拉善','香港','澳门','台北','新北','桃园','台中','台南','高雄','基隆','新竹','嘉义'],                   '省份': ['北京','天津','河北','山西','内蒙古','辽宁','吉林','黑龙江','上海','江苏','浙江','安徽','福建','江西','山东','河南','湖北','湖南','广东','广西','海南','重庆','四川','贵州','云南','西藏','陕西','甘肃','青海','宁夏','新疆','香港','澳门','台湾'],
                    '河流': ['长江','黄河','珠江','黑龙江','松花江','淮河','海河','辽河','澜沧江','怒江','雅鲁藏布江','汉江','嘉陵江','岷江','乌江','湘江','赣江','闽江','钱塘江','瓯江','大渡河','沱江','涪江','渭河','汾河','蓟运河','永定河','潮白河','北运河','南运河','红水河','柳江','郁江','桂江','西江','北江','东江','韩江','九龙江','晋江','瓯江','椒江','甬江','苕溪','新安江','富春江','信江','抚河','修水','清江','酉水','澧水','资水','沅江','白龙江','洮河','湟水','伊洛河','沁河','漳河','卫河','滹沱河','桑干河','大凌河','小凌河','鸭绿江','图们江','绥芬河','额尔齐斯河','塔里木河','叶尔羌河','和田河','阿克苏河','开都河','孔雀河','车尔臣河','疏勒河','黑河','石羊河','无定河','窟野河','秃尾河','延河','洛河','丹江','唐河','白河','沙颍河','涡河','浍河','洪泽湖入江水道','通扬运河','苏北灌溉总渠'],
                    '山脉': ['泰山','华山','衡山','恒山','嵩山','黄山','庐山','峨眉山','普陀山','九华山','五台山','武夷山','长白山','天山','昆仑山','喜马拉雅山','横断山','秦岭','大兴安岭','太行山','巫山','武陵山','雪峰山','南岭','阴山','贺兰山','祁连山','六盘山','大巴山','大别山','井冈山','雁荡山','武当山','青城山','龙虎山','齐云山','三清山','莫干山','天目山','四明山','会稽山','崂山','蓬莱山','沂蒙山','五莲山','云台山','王屋山','老君山','鸡公山','伏牛山','神农架','梵净山','哀牢山','无量山','高黎贡山','怒山','沙鲁里山','邛崃山','岷山','唐古拉山','念青唐古拉山','冈底斯山','喀喇昆仑山','阿尔泰山','准噶尔阿拉套山','桐柏山','罗霄山','幕阜山','九岭山','武功山','大庾岭','骑田岭','都庞岭','越城岭','萌渚岭','五指山','黎母山','吊罗山','尖峰岭','霸王岭','七仙岭','东山','西山','北固山','金山','焦山','圌山','花果山','云龙山','微山','峄山','蒙山','徂徕山','梁山','昆嵛山','牙山','艾山','招虎山','鹤山','浮山','大泽山','茶山','盘山','雾灵山','小五台山','百花山','东灵山','西灵山','海坨山','军都山','燕山'],
                    '湖泊': ['鄱阳湖','洞庭湖','太湖','洪泽湖','巢湖','青海湖','滇池','洱海','抚仙湖','泸沽湖','纳木错','色林错','羊卓雍措','博斯腾湖','兴凯湖','呼伦湖','贝尔湖','乌梁素海','岱海','达里诺尔湖','镜泊湖','五大连池','长白山天池','天山天池','赛里木湖','艾比湖','博湖','阿克塞钦湖','班公错','玛旁雍错','拉昂错','扎日南木错','当惹雍错','鄂陵湖','扎陵湖','微山湖','骆马湖','高邮湖','洪湖','梁子湖','汈汊湖','斧头湖','汈东湖','武昌湖','升金湖','菜子湖','龙感湖','大官湖','黄湖','泊湖','石臼湖','固城湖','滆湖','长荡湖','阳澄湖','淀山湖','澄湖','独山湖','南阳湖','昭阳湖','微山湖','骆马湖','洪泽湖','高邮湖','宝应湖','白马湖','邵伯湖','滆湖','长荡湖','太湖','阳澄湖','淀山湖','澄湖','昆承湖','尚湖','元荡','汾湖','沐阳湖','得胜湖','大纵湖','射阳湖','蜈蚣湖','刁汊湖','汈汊湖','府澴河湖群','汈东湖','武昌湖','升金湖','菜子湖','龙感湖','大官湖','黄湖','泊湖','石臼湖','固城湖','南漪湖','女山湖','七里湖','瓦埠湖','城东湖','城西湖','焦岗湖','高塘湖','花园湖','沂湖','洋湖','白荡湖','枫沙湖','陈瑶湖','白兔湖','嬉子湖','双井湖','汤湖','黄陂湖','清水湖','竹丝湖','黑沙湖','谷湖','小七孔湖','万峰湖','红枫湖','百花湖','草海','威宁草海','异龙湖','杞麓湖','星云湖','程海','阳宗海','碧塔海','属都湖','拉市海','巴松措','然乌湖','玛纳斯湖','艾丁湖','罗布泊','台特玛湖','哈拉奇','居延海','月亮湖','达格图湖','查干诺尔','查干淖尔','乌兰淖尔','吉兰泰盐湖','茶卡盐湖','察尔汗盐湖','大柴旦湖','小柴旦湖','可鲁克湖','托素湖','苏干湖','尕海','花湖','若尔盖湖','黄河首曲湿地湖泊群','扎日南木错','当穹错','昂拉仁错','塔若错','扎布耶茶卡','许如错','普莫雍错','哲古错','错那','错鄂','雅根错','邦达错','多庆错','佩枯错','公珠错','玛尔果茶卡','洞错','隆觉错','仓木错','打加错','昂孜错','戈芒错','扎日南木错','扎布耶茶卡','许如错','普莫雍错','哲古错','错那','错鄂','雅根错','邦达错','多庆错','佩枯错','公珠错','玛尔果茶卡','洞错','隆觉错','仓木错','打加错','昂孜错','戈芒错'],
                    '岛屿': ['台湾岛','海南岛','崇明岛','舟山岛','海坛岛','东海岛','长兴岛','东山岛','玉环岛','大屿山','横沙岛','长兴沙','灵山岛','庙岛','南日岛','万山群岛','上川岛','下川岛','南澳岛','涠洲岛','斜阳岛','硇洲岛','东海岛','兰屿','绿岛','钓鱼岛','黄尾屿','赤尾屿','南小岛','北小岛','棉花屿','花瓶屿','彭佳屿','基隆屿','龟山岛','小琉球','七星岩','太平岛','中业岛','南威岛','弹丸礁','曾母暗沙','永兴岛','七连屿','赵述岛','北岛','中岛','南岛','东岛','西沙洲','中沙洲','南沙洲','银屿','石岛','珊瑚岛','甘泉岛','晋卿岛','琛航岛','广金岛','羚羊礁','全富岛','鸭公岛','咸舍屿','银屿仔','筐仔沙洲','北礁','浪花礁','雄南礁','立地暗沙','八仙暗沙','隐矶滩','欢乐暗沙','舰长暗沙','海马滩','半月礁','司令礁','无乜礁','南屏礁','舶兰礁','安塘礁','道明群礁','双黄沙洲','南钥岛','杨信沙洲','库归礁','法礁','铁线礁','都护暗沙','指掌暗沙','永暑礁','美济岛','仁爱礁','五方礁','信义礁','礼乐滩','安塘滩','榆亚暗沙','二角礁','簸箕礁','光星礁','光星仔礁','息波礁','南海礁','海康暗沙','海安礁','盟谊暗沙','李准滩','西卫滩','万安滩','水暑礁','金盾暗沙','奥南暗沙','南华礁','六门礁','石盘仔','毕生礁','榆亚暗沙','安渡滩','舶兰礁','染青沙洲','景宏岛','鸿庥岛','南薰礁','东门礁','赤瓜礁','鬼喊礁','琼礁','广雅滩','人骏滩','李准滩','西卫滩','万安滩','水暑礁','金盾暗沙','奥南暗沙','南华礁','六门礁','石盘仔','毕生礁','榆亚暗沙','安渡滩','舶兰礁','染青沙洲','景宏岛','鸿庥岛','南薰礁','东门礁','赤瓜礁','鬼喊礁','琼礁','广雅滩','人骏滩','雄南礁','立地暗沙','八仙暗沙','隐矶滩','欢乐暗沙','舰长暗沙','海马滩','半月礁','司令礁','无乜礁','南屏礁','舶兰礁','安塘礁','道明群礁','双黄沙洲','南钥岛','杨信沙洲','库归礁','法礁','铁线礁','都护暗沙','指掌暗沙','永暑礁','美济岛','仁爱礁','五方礁','信义礁','礼乐滩','安塘滩','榆亚暗沙','二角礁','簸箕礁','光星礁','光星仔礁','息波礁','南海礁','海康暗沙','海安礁','盟谊暗沙','李准滩','西卫滩','万安滩','水暑礁','金盾暗沙','奥南暗沙','南华礁','六门礁','石盘仔','毕生礁','榆亚暗沙','安渡滩','舶兰礁','染青沙洲','景宏岛','鸿庥岛','南薰礁','东门礁','赤瓜礁','鬼喊礁','琼礁','广雅滩','人骏滩','雄南礁','立地暗沙','八仙暗沙','隐矶滩','欢乐暗沙','舰长暗沙','海马滩','半月礁','司令礁','无乜礁','南屏礁','舶兰礁','安塘礁','道明群礁','双黄沙洲','南钥岛','杨信沙洲','库归礁','法礁','铁线礁','都护暗沙','指掌暗沙','永暑礁','美济岛','仁爱礁','五方礁','信义礁','礼乐滩','安塘滩','榆亚暗沙','二角礁','簸箕礁','光星礁','光星仔礁','息波礁','南海礁','海康暗沙','海安礁','盟谊暗沙','李准滩','西卫滩','万安滩','水暑礁','金盾暗沙','奥南暗沙','南华礁','六门礁','石盘仔','毕生礁','榆亚暗沙','安渡滩','舶兰礁','染青沙洲','景宏岛','鸿庥岛','南薰礁','东门礁','赤瓜礁','鬼喊礁','琼礁','广雅滩','人骏滩'],
                    '红色': ['解放', '光明', '新生', '崭新', '奋进', '复兴', '振兴', '自强', '自立', '自由', '和平', '安宁', '团结', '进步', '发展', '富强', '民主', '文明', '和谐', '繁荣', '昌盛', '兴隆', '腾飞', '飞跃', '崛起', '朝阳', '旭日', '曙光', '晨曦', '春晖', '红旗', '东方', '红星', '丹心', '赤诚', '先锋', '先烈', '英雄', '志士', '仁人', '康庄', '大道', '宏图', '伟业', '鸿猷', '清源', '正气', '浩然', '崇德', '向善', '启明', '开明', '启航', '扬帆', '远征', '惠民', '利民', '为民', '安民', '乐业', '锦绣', '锦程', '华章', '盛世', '清平']
                },
            };
            
            // 清除本地存储中的词库数据
            try {
                localStorage.removeItem('placeNameChars');
                console.log('本地存储中的词库数据已清除');
            } catch (error) {
                console.error('清除本地存储失败:', error);
            }
            
            // 重新初始化词库类型选择
            initTypeSelect();
            
            // 重新初始化词库选择下拉框
            initLibrarySelect();
            
            // 更新字符输入框，确保复选框状态正确
            updateCharacterInputs();
            
            // 显示成功消息
            alert('已恢复出厂设置，词库已重置为默认状态。');
        }
        
        // 辅助函数：从数组中随机获取元素
        function getRandomElement(array) {
            return array[Math.floor(Math.random() * array.length)];
        }
        
        // 复制结果到剪贴板
        function copyToClipboard() {
            const resultElement = document.getElementById('result');
            const textToCopy = resultElement.textContent;
            
            if (textToCopy && textToCopy !== '点击上方按钮生成地名' && textToCopy !== '生成中...') {
                // 优先使用现代的 Clipboard API
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(textToCopy)
                        .then(() => {
                            alert('复制成功！');
                        })
                        .catch(err => {
                            console.error('复制失败:', err);
                            // 降级到传统方法
                            fallbackCopyTextToClipboard(textToCopy);
                        });
                } else {
                    // 使用传统方法作为降级方案
                    fallbackCopyTextToClipboard(textToCopy);
                }
            } else {
                alert('没有可复制的内容');
            }
        }
        
        // 降级复制方法，支持移动端
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            
            // 设置样式，使其在页面上不可见但仍然可选中
            textArea.style.position = 'fixed';
            textArea.style.top = '-999999px';
            textArea.style.left = '-999999px';
            textArea.style.width = '2em';
            textArea.style.height = '2em';
            textArea.style.padding = '0';
            textArea.style.border = 'none';
            textArea.style.outline = 'none';
            textArea.style.boxShadow = 'none';
            textArea.style.background = 'transparent';
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                const msg = successful ? '复制成功！' : '复制失败，请手动复制';
                alert(msg);
            } catch (err) {
                console.error('复制失败:', err);
                alert('复制失败，请手动复制');
            }
            
            document.body.removeChild(textArea);
        }
        
        // 打开词库管理
        function openLibraryManagement() {
            // 创建弹窗
            let modal = document.getElementById('library-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'library-modal';
                modal.className = 'library-modal';
                modal.innerHTML = `
                    <div class="library-modal-content">
                        <div class="library-modal-header">
                            <h3>词库管理</h3>
                            <button class="btn btn-secondary" onclick="closeLibraryModal()" style="font-size: 24px; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">&times;</button>
                        </div>
                        <div class="library-panel">
                            <div class="library-section">
                                <h4>词库类型管理</h4>
                                <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px;">
                                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                        <select id="type-select" onchange="changeType()" style="flex: 1; min-width: 150px; padding: 8px;"></select>
                                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                            <button class="btn btn-success" onclick="addNewType()" style="padding: 5px 10px; font-size: 12px;">新增类型</button>
                                            <button class="btn btn-warning" onclick="renameType()" style="padding: 5px 10px; font-size: 12px;">重命名</button>
                                            <button class="btn btn-danger" onclick="deleteType()" style="padding: 5px 10px; font-size: 12px;">删除</button>
                                            <button class="btn btn-info" onclick="showAddLibraryToTypeModal()" style="padding: 5px 10px; font-size: 12px;">添加词库</button>
                                        </div>
                                    </div>
                                </div>
                                <div id="type-libraries-container" style="margin-top: 10px;">
                                    <p style="font-size: 14px; margin-bottom: 8px;">该类型下的词库：</p>
                                    <div id="type-libraries-list" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; background-color: var(--card-bg); border-radius: 5px; border: 1px solid var(--border-color);"></div>
                                </div>
                            </div>
                            <div class="library-section">
                                <h4>词库选择</h4>
                                <select id="library-select" onchange="changeLibrary()" style="width: 100%; padding: 8px; margin-bottom: 10px;"></select>
                                <div class="library-actions" style="flex-wrap: wrap;">
                                    <button class="btn btn-success" onclick="addNewLibrary()">新增</button>
                                    <button class="btn btn-warning" onclick="renameLibrary()">重命名</button>
                                    <button class="btn btn-danger" onclick="deleteLibrary()">删除</button>
                                    <button class="btn btn-info" onclick="importLibrary()">导入</button>
                                    <button class="btn btn-primary" onclick="exportLibrary()">导出</button>
                                </div>
                            </div>
                            <div class="library-section">
                                <h4>词库内容（自动适应宽度）</h4>
                                <textarea id="library-textarea" class="library-textarea" placeholder="在此输入词库内容，字符之间用空格或换行分隔"></textarea>
                            </div>
                        </div>
                        <div class="library-controls" style="display: flex; justify-content: space-between; align-items: center;">
                            <button class="btn btn-secondary" onclick="resetToDefaultLibraries()">恢复出厂设置</button>
                            <button class="btn btn-primary" onclick="saveLibraryChanges()">保存更改</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // 添加窗口大小变化事件监听器
                const textarea = document.getElementById('library-textarea');
                if (textarea) {
                    // 添加 resize 事件监听器
                    const resizeObserver = new ResizeObserver(() => {
                        updateLibraryTextarea();
                    });
                    resizeObserver.observe(textarea);
                }
            }
            
            // 初始化词库类型选择
            initTypeSelect();
            
            // 初始化词库选择下拉框
            initLibrarySelect();
            
            updateLibraryTextarea();
            
            // 显示弹窗
            modal.style.display = 'block';
        }
        
        // 字符设置数组
        let characterSettings = [];
        
        // 历史记录数组
        let placeNameHistory = [];
        
        // 初始化字符输入框
        function initCharacterInputs() {
            try {
                updateCharacterInputs();
                console.log('字符输入框初始化成功');
                // 初始化可选栏数
                updateAvailableColumns();
            } catch (error) {
                console.error('字符输入框初始化失败:', error);
            }
        }
        
        // 更新字符输入框
        function updateCharacterInputs() {
            try {
                const nameLengthElement = document.getElementById('name-length');
                if (!nameLengthElement) {
                    console.error('找不到name-length元素');
                    return;
                }
                
                const partCount = parseInt(nameLengthElement.value) || 3;
                const characterInputsElement = document.getElementById('character-inputs');
                if (!characterInputsElement) {
                    console.error('找不到character-inputs元素');
                    return;
                }
                
                characterInputsElement.innerHTML = '';
                
                // 保存当前的字符设置
                const currentSettings = [...characterSettings];
                
                // 重置字符设置
                characterSettings = [];
                
                // 生成指定数量的字符输入框
                for (let inputCount = 0; inputCount < partCount; inputCount++) { // 生成指定数量的输入框
                    // 使用之前的设置或默认设置
                    let settings;
                    if (inputCount < currentSettings.length) {
                        settings = {
                            index: inputCount,
                            locked: currentSettings[inputCount].locked || false,
                            customChar: currentSettings[inputCount].customChar || '',
                            library: currentSettings[inputCount].library || '',
                            libraries: currentSettings[inputCount].libraries || [],
                            type: currentSettings[inputCount].type || '单字'
                        };
                    } else {
                        // 默认设置
                        settings = {
                            index: inputCount,
                            locked: false,
                            customChar: '',
                            library: '',
                            libraries: [],
                            type: '单字'
                        };
                    }
                    characterSettings.push(settings);
                    
                    // 创建字符输入组
                    const characterInputGroup = document.createElement('div');
                    characterInputGroup.className = 'character-input-group';
                    
                    // 创建标题
                    const title = document.createElement('h4');
                    title.textContent = `第${inputCount + 1}部分`;
                    characterInputGroup.appendChild(title);
                    
                    // 创建词库类型选择
                    const typeSelectItem = document.createElement('div');
                    typeSelectItem.className = 'character-input-item';
                    
                    const typeLabel = document.createElement('label');
                    typeLabel.htmlFor = `type-select-${inputCount}`;
                    typeLabel.textContent = '词库类型：';
                    typeSelectItem.appendChild(typeLabel);
                    
                    const typeSelect = document.createElement('select');
                    typeSelect.id = `type-select-${inputCount}`;
                    typeSelect.style.width = '100%';
                    typeSelect.onchange = (function(index) {
                        return function() {
                            updateCharacterType(index);
                        };
                    })(inputCount);
                    
                    // 添加词库类型选项
                    const types = Object.keys(placeNameChars);
                    types.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        if (type === (settings.type || '单字')) {
                            option.selected = true;
                        }
                        typeSelect.appendChild(option);
                    });
                    
                    typeSelectItem.appendChild(typeSelect);
                    characterInputGroup.appendChild(typeSelectItem);
                    
                    // 创建词库选择
                    const librarySelectItem = document.createElement('div');
                    librarySelectItem.className = 'character-input-item';
                    
                    // 创建标签容器
                    const labelContainer = document.createElement('div');
                    labelContainer.style.display = 'flex';
                    labelContainer.style.alignItems = 'center';
                    labelContainer.style.justifyContent = 'space-between';
                    labelContainer.style.width = '100%';
                    labelContainer.style.flexWrap = 'wrap';
                    labelContainer.style.gap = '5px';
                    
                    // 创建标签
                    const label = document.createElement('label');
                    label.htmlFor = `library-select-${inputCount}`;
                    label.textContent = '词库选择：';
                    labelContainer.appendChild(label);
                    
                    // 创建选择按钮容器
                    const selectBtnContainer = document.createElement('div');
                    selectBtnContainer.style.display = 'flex';
                    selectBtnContainer.style.gap = '5px';
                    selectBtnContainer.style.flexWrap = 'wrap';
                    selectBtnContainer.style.justifyContent = 'flex-end';
                    
                    // 创建全选按钮
                    const selectAllBtn = document.createElement('button');
                    selectAllBtn.className = 'btn btn-primary';
                    selectAllBtn.textContent = '全选';
                    selectAllBtn.style.padding = '3px 6px';
                    selectAllBtn.style.fontSize = '11px';
                    selectAllBtn.style.whiteSpace = 'nowrap';
                    selectAllBtn.dataset.state = 'select'; // 状态：select, deselect
                    selectAllBtn.onclick = (function(index) {
                        return function() {
                            toggleSelectAllLibraries(index);
                        };
                    })(inputCount);
                    selectBtnContainer.appendChild(selectAllBtn);
                    
                    // 创建反选按钮
                    const invertBtn = document.createElement('button');
                    invertBtn.className = 'btn btn-warning';
                    invertBtn.textContent = '反选';
                    invertBtn.style.padding = '3px 6px';
                    invertBtn.style.fontSize = '11px';
                    invertBtn.style.whiteSpace = 'nowrap';
                    invertBtn.onclick = (function(index) {
                        return function() {
                            invertSelectLibraries(index);
                        };
                    })(inputCount);
                    selectBtnContainer.appendChild(invertBtn);
                    
                    // 创建清空按钮
                    const clearLibraryBtn = document.createElement('button');
                    clearLibraryBtn.className = 'btn btn-danger';
                    clearLibraryBtn.textContent = '清空';
                    clearLibraryBtn.style.padding = '3px 6px';
                    clearLibraryBtn.style.fontSize = '11px';
                    clearLibraryBtn.style.whiteSpace = 'nowrap';
                    clearLibraryBtn.onclick = (function(index) {
                        return function() {
                            clearLibrarySelection(index);
                        };
                    })(inputCount);
                    selectBtnContainer.appendChild(clearLibraryBtn);
                    
                    labelContainer.appendChild(selectBtnContainer);
                    
                    librarySelectItem.appendChild(labelContainer);
                    
                    // 创建词库选择容器
                    const libraryContainer = document.createElement('div');
                    libraryContainer.id = `library-select-${inputCount}`;
                    libraryContainer.style.display = 'flex';
                    libraryContainer.style.flexWrap = 'wrap';
                    libraryContainer.style.gap = '10px';
                    libraryContainer.style.marginTop = '5px';
                    libraryContainer.style.alignItems = 'center';
                    libraryContainer.style.width = '100%';
                    
                    // 动态生成选项，基于选择的词库类型
                    const currentType = settings.type || '单字';
                    const libraryNames = placeNameChars[currentType] ? Object.keys(placeNameChars[currentType]) : [];
                    console.log('可用词库:', libraryNames);
                    
                    // 确保 settings.libraries 数组存在
                    if (!settings.libraries) {
                        settings.libraries = settings.library ? [settings.library] : [];
                    }
                    
                    libraryNames.forEach(libraryName => {
                        const checkboxContainer = document.createElement('div');
                        checkboxContainer.style.display = 'flex';
                        checkboxContainer.style.alignItems = 'center';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `library-checkbox-${inputCount}-${libraryName}`;
                        checkbox.value = libraryName;
                        checkbox.checked = Array.isArray(settings.libraries) && settings.libraries.includes(libraryName);
                        checkbox.style.transform = 'scale(1.2)';
                        checkbox.style.marginRight = '8px';
                        checkbox.onchange = (function(index) {
                            return function() {
                                updateCharacterLibraries(index);
                            };
                        })(inputCount);
                        
                        const checkboxLabel = document.createElement('label');
                        checkboxLabel.htmlFor = `library-checkbox-${inputCount}-${libraryName}`;
                        checkboxLabel.textContent = libraryName;
                        checkboxLabel.style.marginLeft = '4px';
                        checkboxLabel.style.fontSize = '14px';
                        
                        checkboxContainer.appendChild(checkbox);
                        checkboxContainer.appendChild(checkboxLabel);
                        libraryContainer.appendChild(checkboxContainer);
                    });
                    
                    librarySelectItem.appendChild(libraryContainer);
                    characterInputGroup.appendChild(librarySelectItem);
                    
                    // 创建自定义字符输入
                    const charInputItem = document.createElement('div');
                    charInputItem.className = 'character-input-item';
                    
                    // 创建标签
                    const charLabel = document.createElement('label');
                    charLabel.htmlFor = `custom-char-${inputCount}`;
                    charLabel.textContent = '自定义字符：';
                    charInputItem.appendChild(charLabel);
                    
                    // 创建输入框容器
                    const inputContainer = document.createElement('div');
                    inputContainer.style.display = 'flex';
                    inputContainer.style.alignItems = 'center';
                    inputContainer.style.flex = '1';
                    
                    // 创建输入框
                    const charInput = document.createElement('input');
                    charInput.type = 'text';
                    charInput.id = `custom-char-${inputCount}`;
                    charInput.style.width = '70%';
                    // 不再限制最大长度，允许用户输入任意长度的字符
                    charInput.placeholder = '输入来锁定字符';
                    charInput.value = settings.customChar || '';
                    // 使用闭包保存当前索引值
                    charInput.oninput = (function(index) {
                        return function() {
                            updateCustomChar(index);
                        };
                    })(inputCount);
                    inputContainer.appendChild(charInput);
                    
                    // 创建锁定状态
                    const lockStatus = document.createElement('span');
                    lockStatus.id = `lock-status-${inputCount}`;
                    lockStatus.className = 'lock-status';
                    lockStatus.style.marginLeft = '10px';
                    lockStatus.style.whiteSpace = 'nowrap';
                    if (settings.locked) {
                        lockStatus.textContent = '已锁定';
                        lockStatus.className = 'lock-status locked';
                    } else {
                        lockStatus.textContent = '留空随机';
                        lockStatus.className = 'lock-status';
                    }
                    inputContainer.appendChild(lockStatus);
                    
                    charInputItem.appendChild(inputContainer);
                    
                    // 创建按钮容器
                    const btnContainer = document.createElement('div');
                    btnContainer.style.display = 'flex';
                    btnContainer.style.alignItems = 'center';
                    btnContainer.style.gap = '10px';
                    btnContainer.style.marginTop = '10px';
                    btnContainer.style.width = '100%';
                    btnContainer.style.boxSizing = 'border-box';
                    btnContainer.style.flexWrap = 'wrap';
                    
                    // 创建添加到词库按钮
                    const addToLibraryBtn = document.createElement('button');
                    addToLibraryBtn.className = 'btn btn-success';
                    addToLibraryBtn.textContent = '添加到词库';
                    addToLibraryBtn.style.flex = '1';
                    addToLibraryBtn.style.whiteSpace = 'nowrap';
                    addToLibraryBtn.onclick = (function(index) {
                        return function() {
                            addCharToLibrary(index);
                        };
                    })(inputCount);
                    btnContainer.appendChild(addToLibraryBtn);
                    
                    // 创建从词库选择按钮
                    const selectFromLibraryBtn = document.createElement('button');
                    selectFromLibraryBtn.className = 'btn btn-primary';
                    selectFromLibraryBtn.textContent = '选字符';
                    selectFromLibraryBtn.style.flex = '1';
                    selectFromLibraryBtn.style.whiteSpace = 'nowrap';
                    selectFromLibraryBtn.onclick = (function(index) {
                        return function() {
                            selectCharFromLibrary(index);
                        };
                    })(inputCount);
                    btnContainer.appendChild(selectFromLibraryBtn);
                    
                    // 创建清空按钮
                    const clearBtn = document.createElement('button');
                    clearBtn.className = 'btn btn-danger';
                    clearBtn.textContent = '清空';
                    clearBtn.style.flex = '1';
                    clearBtn.style.whiteSpace = 'nowrap';
                    clearBtn.onclick = (function(index) {
                        return function() {
                            clearCustomChar(index);
                        };
                    })(inputCount);
                    btnContainer.appendChild(clearBtn);
                    
                    characterInputGroup.appendChild(charInputItem);
                    
                    // 将按钮容器直接添加到输入组中，这样它会占满整个宽度
                    characterInputGroup.appendChild(btnContainer);
                    
                    characterInputsElement.appendChild(characterInputGroup);
                }
                
                console.log('字符输入框更新成功，输入框数量:', partCount);
            } catch (error) {
                console.error('更新字符输入框失败:', error);
                // 显示错误信息
                const characterInputsElement = document.getElementById('character-inputs');
                if (characterInputsElement) {
                    characterInputsElement.innerHTML = `<div style="color: red; padding: 10px;">错误：无法生成字符输入框，请刷新页面重试</div>`;
                }
            }
        }
        
        // 更新可选栏数
        function updateAvailableColumns() {
            const nameLengthElement = document.getElementById('name-length');
            if (!nameLengthElement) {
                console.error('找不到name-length元素');
                return;
            }
            
            // 保存当前的onchange事件处理函数
            const originalOnChange = nameLengthElement.onchange;
            // 暂时移除onchange事件处理函数，避免无限递归
            nameLengthElement.onchange = null;
            
            // 更新组合部分数量下拉框的选项
            const currentValue = nameLengthElement.value;
            nameLengthElement.innerHTML = '';
            
            // 生成从2到10的选项，让用户可以自由选择
            for (let i = 1; i <= 10; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i}部分`;
                if (i === parseInt(currentValue) || (i === 3 && !currentValue)) {
                    option.selected = true;
                }
                nameLengthElement.appendChild(option);
            }
            
            // 重新添加onchange事件处理函数
            nameLengthElement.onchange = originalOnChange;
        }
        
        // 更新自定义字符
        function updateCustomChar(index) {
            const customChar = document.getElementById(`custom-char-${index}`).value;
            const lockStatusElement = document.getElementById(`lock-status-${index}`);
            
            characterSettings[index].customChar = customChar;
            
            if (customChar) {
                // 有输入，自动锁定
                characterSettings[index].locked = true;
                if (lockStatusElement) {
                    lockStatusElement.textContent = '已锁定';
                    lockStatusElement.className = 'lock-status locked';
                }
            } else {
                // 无输入，自动解锁
                characterSettings[index].locked = false;
                if (lockStatusElement) {
                    lockStatusElement.textContent = '留空随机';
                    lockStatusElement.className = 'lock-status';
                }
            }
        }
        
        // 更新词库类型
        function updateCharacterType(index) {
            const typeSelect = document.getElementById(`type-select-${index}`);
            const librarySelect = document.getElementById(`library-select-${index}`);
            
            if (typeSelect) {
                const newType = typeSelect.value;
                characterSettings[index].type = newType;
                console.log(`第${index + 1}部分的词库类型已更新为: ${newType}`);
                
                // 更新词库选择容器
                if (librarySelect) {
                    // 清空现有选项
                    librarySelect.innerHTML = '';
                    
                    // 添加新类型的词库选项（复选框形式）
                    const libraryNames = placeNameChars[newType] ? Object.keys(placeNameChars[newType]) : [];
                    libraryNames.forEach(libraryName => {
                        const checkboxContainer = document.createElement('div');
                        checkboxContainer.style.display = 'flex';
                        checkboxContainer.style.alignItems = 'center';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `library-checkbox-${index}-${libraryName}`;
                        checkbox.value = libraryName;
                        checkbox.checked = false; // 默认不选中
                        checkbox.style.transform = 'scale(1.2)';
                        checkbox.style.marginRight = '8px';
                        checkbox.onchange = (function(index) {
                            return function() {
                                updateCharacterLibraries(index);
                            };
                        })(index);
                        
                        const checkboxLabel = document.createElement('label');
                        checkboxLabel.htmlFor = `library-checkbox-${index}-${libraryName}`;
                        checkboxLabel.textContent = libraryName;
                        checkboxLabel.style.marginLeft = '4px';
                        checkboxLabel.style.fontSize = '14px';
                        
                        checkboxContainer.appendChild(checkbox);
                        checkboxContainer.appendChild(checkboxLabel);
                        librarySelect.appendChild(checkboxContainer);
                    });
                    
                    // 更新词库设置
                    characterSettings[index].library = libraryNames[0] || '';
                    characterSettings[index].libraries = libraryNames.length > 0 ? [libraryNames[0]] : [];
                }
                
                // 不再根据词库类型限制输入框的最大长度
                const charInput = document.getElementById(`custom-char-${index}`);
                if (charInput) {
                    // 移除最大长度限制，允许用户输入任意长度的字符
                    charInput.removeAttribute('maxLength');
                }
                
                // 更新字符输入框，根据词库类型和总地名字数调整输入框数量
                updateCharacterInputs();
            }
        }
        

        
        // 更新多个字符词库
        function updateCharacterLibraries(index) {
            const libraryContainer = document.getElementById(`library-select-${index}`);
            if (libraryContainer) {
                const checkboxes = libraryContainer.querySelectorAll('input[type="checkbox"]');
                const selectedLibraries = Array.from(checkboxes)
                    .filter(checkbox => checkbox.checked)
                    .map(checkbox => checkbox.value);
                
                characterSettings[index].libraries = selectedLibraries;
                // 同时更新单个词库设置，保持兼容性
                characterSettings[index].library = selectedLibraries[0] || '';
                console.log(`第${index + 1}部分的词库已更新为: ${selectedLibraries.join(', ')}`);
            }
        }
        
        // 全选/取消全选词库
        function toggleSelectAllLibraries(index) {
            const libraryContainer = document.getElementById(`library-select-${index}`);
            const selectAllBtn = libraryContainer.previousElementSibling.querySelector('.btn:first-child');
            if (libraryContainer && selectAllBtn) {
                const checkboxes = libraryContainer.querySelectorAll('input[type="checkbox"]');
                const currentState = selectAllBtn.dataset.state || 'select';
                
                switch(currentState) {
                    case 'select':
                        // 全选
                        checkboxes.forEach(checkbox => {
                            checkbox.checked = true;
                        });
                        selectAllBtn.textContent = '取消全选';
                        selectAllBtn.dataset.state = 'deselect';
                        break;
                    case 'deselect':
                        // 取消全选
                        checkboxes.forEach(checkbox => {
                            checkbox.checked = false;
                        });
                        selectAllBtn.textContent = '全选';
                        selectAllBtn.dataset.state = 'select';
                        break;
                }
                
                // 更新词库设置
                updateCharacterLibraries(index);
            }
        }
        
        // 反选词库
        function invertSelectLibraries(index) {
            const libraryContainer = document.getElementById(`library-select-${index}`);
            if (libraryContainer) {
                const checkboxes = libraryContainer.querySelectorAll('input[type="checkbox"]');
                
                // 反选所有复选框
                checkboxes.forEach(checkbox => {
                    checkbox.checked = !checkbox.checked;
                });
                
                // 更新词库设置
                updateCharacterLibraries(index);
            }
        }
        
        // 清空词库选择
        function clearLibrarySelection(index) {
            const libraryContainer = document.getElementById(`library-select-${index}`);
            if (libraryContainer) {
                const checkboxes = libraryContainer.querySelectorAll('input[type="checkbox"]');
                
                // 清空所有复选框
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                // 更新词库设置
                updateCharacterLibraries(index);
            }
        }
        
        // 从词库中选择字符
        function selectCharFromLibrary(index) {
            try {
                const settings = characterSettings[index];
                if (!settings) {
                    console.error(`找不到第${index}个字符的设置`);
                    return;
                }
                
                let libraryNames = settings.libraries || [];
                const type = settings.type || '单字';
                
                // 如果词库未设置，选择该分类下的第一个可用词库
                if (libraryNames.length === 0) {
                    const allLibraries = Object.keys(placeNameChars[type]);
                    if (allLibraries.length > 0) {
                        libraryNames = [allLibraries[0]];
                    } else {
                        // 如果没有可用词库，使用单字分类下的第一个词库
                        const singleCharLibraries = Object.keys(placeNameChars['单字']);
                        if (singleCharLibraries.length > 0) {
                            libraryNames = [singleCharLibraries[0]];
                        } else {
                            alert('没有可用的词库');
                            return;
                        }
                    }
                }
                
                // 收集所有选中词库的字符
                let allChars = [];
                libraryNames.forEach(libraryName => {
                    const charArray = placeNameChars[type][libraryName] || [];
                    allChars = allChars.concat(charArray);
                });
                
                if (allChars.length === 0) {
                    alert('所选词库为空，请先添加字符');
                    return;
                }
                
                // 创建选择弹窗
                let modal = document.getElementById('char-select-modal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'char-select-modal';
                    modal.className = 'library-modal';
                    document.body.appendChild(modal);
                }
                
                // 生成字符选择界面
                let charItemsHTML = '';
                allChars.forEach(char => {
                    charItemsHTML += `<div class="char-item" onclick="selectChar('${char}', ${index})"><center>${char}</center></div>`;
                });
                
                modal.innerHTML = `
                    <div class="library-modal-content">
                        <div class="library-modal-header">
                            <h3>从词库选择字符</h3>
                            <button class="btn btn-secondary" onclick="closeCharSelectModal()" style="font-size: 24px; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">&times;</button>
                        </div>
                        <div class="library-content">
                            ${charItemsHTML}
                        </div>
                    </div>
                `;
                
                // 显示弹窗
                modal.style.display = 'block';
            } catch (error) {
                console.error('从词库选择字符失败:', error);
                alert('从词库选择字符失败');
            }
        }
        
        // 添加字符到词库
        function addCharToLibrary(index) {
            try {
                const settings = characterSettings[index];
                if (!settings) {
                    console.error(`找不到第${index}个字符的设置`);
                    return;
                }
                
                const customChar = document.getElementById(`custom-char-${index}`).value;
                if (!customChar) {
                    alert('请先输入要添加的字符');
                    return;
                }
                
                const type = settings.type || '单字';
                const allLibraries = Object.keys(placeNameChars[type]);
                
                if (allLibraries.length === 0) {
                    alert('该分类下没有可用词库');
                    return;
                }
                
                // 创建选择弹窗
                let modal = document.getElementById('library-select-modal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'library-select-modal';
                    modal.className = 'library-modal';
                    document.body.appendChild(modal);
                }
                
                // 生成词库选择界面
                let checkboxesHTML = '';
                allLibraries.forEach(libraryName => {
                    checkboxesHTML += `
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <input type="checkbox" id="add-to-${libraryName}" value="${libraryName}" style="transform: scale(1.2); margin-right: 10px; border: 1px solid var(--input-border); background-color: var(--container-bg); transition: border-color 0.3s ease, background-color 0.3s ease;">
                            <label for="add-to-${libraryName}" style="font-size: 14px; cursor: pointer; color: var(--text-color); transition: color 0.3s ease;">${libraryName}</label>
                        </div>
                    `;
                });
                
                modal.innerHTML = `
                    <div class="library-modal-content" style="max-width: 500px; background-color: var(--container-bg); border: 1px solid var(--border-color); transition: background-color 0.3s ease, border-color 0.3s ease;">
                        <div class="library-modal-header">
                            <h3 style="color: var(--text-color); transition: color 0.3s ease;">选择要添加到的词库</h3>
                            <button class="btn btn-secondary" onclick="closeLibrarySelectModal()" style="font-size: 24px; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">&times;</button>
                        </div>
                        <div class="library-content" style="max-height: 300px; overflow-y: auto;">
                            <p style="margin-bottom: 15px; font-size: 14px; color: var(--text-color); transition: color 0.3s ease;">请选择要将 "${customChar}" 添加到的词库：</p>
                            <div style="background-color: var(--card-bg); padding: 15px; border-radius: 5px; border: 1px solid var(--border-color); transition: background-color 0.3s ease, border-color 0.3s ease; width: 100%; box-sizing: border-box;">
                                ${checkboxesHTML}
                            </div>
                        </div>
                        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="closeLibrarySelectModal()">取消</button>
                            <button class="btn btn-primary" onclick="confirmAddToLibraries(${index}, '${customChar}', '${type}')">确认添加</button>
                        </div>
                    </div>
                `;
                
                // 显示弹窗
                modal.style.display = 'block';
            } catch (error) {
                console.error('添加字符到词库失败:', error);
                alert('添加字符到词库失败');
            }
        }
        
        // 关闭词库选择弹窗
        function closeLibrarySelectModal() {
            const modal = document.getElementById('library-select-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // 确认添加到词库
        function confirmAddToLibraries(index, customChar, type) {
            try {
                const modal = document.getElementById('library-select-modal');
                if (!modal) return;
                
                // 获取选中的词库
                const checkboxes = modal.querySelectorAll('input[type="checkbox"]:checked');
                const selectedLibraries = Array.from(checkboxes).map(cb => cb.value);
                
                if (selectedLibraries.length === 0) {
                    alert('请至少选择一个词库');
                    return;
                }
                
                // 添加字符到选中的词库
                let addedCount = 0;
                selectedLibraries.forEach(libraryName => {
                    if (placeNameChars[type][libraryName]) {
                        // 检查字符是否已存在
                        if (!placeNameChars[type][libraryName].includes(customChar)) {
                            placeNameChars[type][libraryName].push(customChar);
                            addedCount++;
                        }
                    }
                });
                
                // 关闭弹窗
                modal.style.display = 'none';
                
                // 显示结果
                if (addedCount > 0) {
                    alert(`成功添加字符到 ${addedCount} 个词库`);
                } else {
                    alert('字符已存在于所有选中的词库中');
                }
            } catch (error) {
                console.error('确认添加到词库失败:', error);
                alert('添加失败，请重试');
            }
        }
        
        // 选择字符
        function selectChar(char, index) {
            try {
                // 填入自定义字符输入框
                const charInput = document.getElementById(`custom-char-${index}`);
                if (charInput) {
                    charInput.value = char;
                    // 更新自定义字符设置
                    updateCustomChar(index);
                }
                
                // 关闭弹窗
                closeCharSelectModal();
            } catch (error) {
                console.error('选择字符失败:', error);
            }
        }
        
        // 关闭字符选择弹窗
        function closeCharSelectModal() {
            const modal = document.getElementById('char-select-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // 清空所有自定义字符
        function clearAllCustomChars() {
            try {
                // 确认用户是否要清空
                if (!confirm('确定要清空所有自定义字符吗？')) {
                    return;
                }
                
                // 遍历所有字符设置
                characterSettings.forEach((setting, index) => {
                    // 清空自定义字符
                    setting.customChar = '';
                    setting.locked = false;
                    
                    // 更新输入框
                    const charInput = document.getElementById(`custom-char-${index}`);
                    if (charInput) {
                        charInput.value = '';
                    }
                    
                    // 更新锁定状态
                    const lockStatus = document.getElementById(`lock-status-${index}`);
                    if (lockStatus) {
                        lockStatus.textContent = '留空随机';
                        lockStatus.className = 'lock-status';
                    }
                });
                
                // 刷新字符输入框
                updateCharacterInputs();
                
                // 显示成功消息
                alert('所有自定义字符已清空');
            } catch (error) {
                console.error('清空自定义字符失败:', error);
                alert('清空自定义字符失败');
            }
        }
        
        // 清空单个自定义字符
        function clearCustomChar(index) {
            try {
                // 清空自定义字符
                if (characterSettings[index]) {
                    characterSettings[index].customChar = '';
                    characterSettings[index].locked = false;
                    
                    // 更新输入框
                    const charInput = document.getElementById(`custom-char-${index}`);
                    if (charInput) {
                        charInput.value = '';
                    }
                    
                    // 更新锁定状态
                    const lockStatus = document.getElementById(`lock-status-${index}`);
                    if (lockStatus) {
                        lockStatus.textContent = '留空随机';
                        lockStatus.className = 'lock-status';
                    }
                }
            } catch (error) {
                console.error('清空自定义字符失败:', error);
            }
        }
        
        // 生成单个地名的核心逻辑
        function generateSinglePlaceName(partCount) {
            let placeName = '';
            
            for (let i = 0; i < partCount; i++) {
                const settings = characterSettings[i];
                if (!settings) {
                    console.error(`找不到第${i}个字符的设置`);
                    continue;
                }
                
                let part;
                if (settings.locked && settings.customChar) {
                    // 使用锁定的自定义字符
                    part = settings.customChar;
                } else {
                    // 从词库中随机选择字符
                    let libraryNames = settings.libraries || [];
                    const type = settings.type || '单字';
                    
                    // 如果没有选择词库，使用单个词库设置或默认词库
                    if (libraryNames.length === 0) {
                        let libraryName = settings.library || '';
                        if (!libraryName) {
                            // 选择该分类下的第一个可用词库
                            const allLibraries = Object.keys(placeNameChars[type]);
                            if (allLibraries.length > 0) {
                                libraryName = allLibraries[0];
                            } else {
                                // 如果没有可用词库，使用单字分类下的第一个词库
                                const singleCharLibraries = Object.keys(placeNameChars['单字']);
                                if (singleCharLibraries.length > 0) {
                                    libraryName = singleCharLibraries[0];
                                } else {
                                    throw new Error('没有可用的词库');
                                }
                            }
                        }
                        libraryNames = [libraryName];
                    }
                    
                    // 收集所有选中词库的字符
                    let allChars = [];
                    libraryNames.forEach(libraryName => {
                        const charArray = placeNameChars[type][libraryName] || [];
                        allChars = allChars.concat(charArray);
                    });
                    
                    if (allChars.length === 0) {
                        throw new Error('所选词库为空，请先添加字符');
                    }
                    
                    part = getRandomElement(allChars);
                }
                
                placeName += part;
            }
            
            return placeName;
        }
        
        // 生成单个地名（支持锁定字符）
        function generatePlaceName() {
            try {
                const resultElement = document.getElementById('result');
                if (!resultElement) {
                    console.error('找不到result元素');
                    return;
                }
                
                resultElement.textContent = '生成中...';
                
                const partCountElement = document.getElementById('name-length');
                if (!partCountElement) {
                    console.error('找不到name-length元素');
                    resultElement.textContent = '错误：找不到设置元素';
                    return;
                }
                
                const partCount = parseInt(partCountElement.value) || 3;
                console.log('组合部分数量:', partCount);
                
                if (characterSettings.length !== partCount) {
                    console.error('字符设置长度不匹配:', characterSettings.length, 'vs', partCount);
                    // 重新初始化字符设置
                    updateCharacterInputs();
                }
                
                const placeName = generateSinglePlaceName(partCount);
                
                // 显示结果
                setTimeout(() => {
                    // 保留之前的结果，新结果显示在前面
                    const currentResult = resultElement.textContent;
                    if (currentResult && currentResult !== '生成中...' && currentResult !== '点击上方按钮生成地名') {
                        resultElement.textContent = placeName + '\n' + currentResult;
                    } else {
                        resultElement.textContent = placeName;
                    }
                    // 添加到历史记录
                    addToHistory(placeName);
                }, 0); // 使用0延迟，让浏览器有时间更新UI
            } catch (error) {
                console.error('生成地名失败:', error);
                const resultElement = document.getElementById('result');
                if (resultElement) {
                    resultElement.textContent = error.message || '生成失败，请重试';
                }
            }
        }
        
        // 生成多个地名（支持锁定字符）
        function generateMultiplePlaceNames() {
            try {
                // 缓存DOM元素
                const resultElement = document.getElementById('result');
                const partCountElement = document.getElementById('name-length');
                const generateCountElement = document.getElementById('generate-count');
                
                if (!resultElement || !partCountElement || !generateCountElement) {
                    console.error('找不到必要的DOM元素');
                    if (resultElement) {
                        resultElement.textContent = '错误：找不到设置元素';
                    }
                    return;
                }
                
                resultElement.textContent = '生成中...';
                
                // 缓存值
                const partCount = parseInt(partCountElement.value) || 3;
                const generateCount = parseInt(generateCountElement.value) || 5;
                
                console.log('组合部分数量:', partCount);
                console.log('生成数量:', generateCount);
                
                if (characterSettings.length !== partCount) {
                    console.error('字符设置长度不匹配:', characterSettings.length, 'vs', partCount);
                    // 重新初始化字符设置
                    updateCharacterInputs();
                }
                
                const placeNames = [];
                
                // 批量生成地名
                for (let j = 0; j < generateCount; j++) {
                    const placeName = generateSinglePlaceName(partCount);
                    placeNames.push(placeName);
                }
                
                // 批量添加到历史记录
                for (let i = placeNames.length - 1; i >= 0; i--) {
                    addToHistory(placeNames[i]);
                }
                
                // 显示结果
                setTimeout(() => {
                    // 保留之前的结果，新结果显示在前面
                    const currentResult = resultElement.textContent;
                    const newResults = placeNames.join('\n');
                    if (currentResult && currentResult !== '生成中...' && currentResult !== '点击上方按钮生成地名') {
                        resultElement.textContent = newResults + '\n' + currentResult;
                    } else {
                        resultElement.textContent = newResults;
                    }
                }, 0); // 使用0延迟，让浏览器有时间更新UI
            } catch (error) {
                console.error('生成多个地名失败:', error);
                const resultElement = document.getElementById('result');
                if (resultElement) {
                    resultElement.textContent = error.message || '生成失败，请重试';
                }
            }
        }
        
        // 添加到历史记录
        function addToHistory(placeName) {
            if (!placeName) return;
            
            // 限制历史记录数量
            if (placeNameHistory.length >= 50) {
                placeNameHistory.pop();
            }
            
            // 避免重复
            if (!placeNameHistory.includes(placeName)) {
                placeNameHistory.unshift(placeName);
            }
            
            // 更新历史记录显示
            updateHistoryDisplay();
        }
        
        // 更新历史记录显示
        function updateHistoryDisplay() {
            const historyElement = document.getElementById('history');
            if (!historyElement) return;
            
            historyElement.innerHTML = '';
            
            placeNameHistory.forEach(name => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.textContent = name;
                historyItem.onclick = function() {
                    // 点击时的样式变化
                    historyItem.style.backgroundColor = '#3498db';
                    historyItem.style.color = 'white';
                    historyItem.style.transform = 'scale(1.05)';
                    
                    // 点击复制到剪贴板
                    if (navigator.clipboard && window.isSecureContext) {
                        navigator.clipboard.writeText(name)
                            .then(() => {
                                // 显示复制成功的反馈
                                const originalText = historyItem.textContent;
                                historyItem.textContent = '已复制！';
                                setTimeout(() => {
                                    historyItem.textContent = originalText;
                                    // 恢复原始样式
                                    historyItem.style.backgroundColor = '';
                                    historyItem.style.color = '';
                                    historyItem.style.transform = '';
                                }, 1000);
                            })
                            .catch(err => {
                                console.error('复制失败:', err);
                                // 降级到传统方法
                                fallbackCopyTextToClipboard(name);
                                // 恢复原始样式
                                historyItem.style.backgroundColor = '';
                                historyItem.style.color = '';
                                historyItem.style.transform = '';
                            });
                    } else {
                        // 使用传统方法作为降级方案
                        fallbackCopyTextToClipboard(name);
                        // 恢复原始样式
                        historyItem.style.backgroundColor = '';
                        historyItem.style.color = '';
                        historyItem.style.transform = '';
                    }
                };
                historyElement.appendChild(historyItem);
            });
        }
        
        // 更新生成数量显示
        function updateGenerateCount() {
            const generateCountElement = document.getElementById('generate-count');
            const generateCountValueElement = document.getElementById('generate-count-value');
            const btnCountElement = document.getElementById('btn-count');
            
            if (generateCountElement && generateCountValueElement && btnCountElement) {
                const count = generateCountElement.value;
                generateCountValueElement.textContent = count;
                btnCountElement.textContent = count;
            }
        }
        
        // 关闭词库管理弹窗
        function closeLibraryModal() {
            const modal = document.getElementById('library-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // 初始化词库类型选择
        function initTypeSelect() {
            const typeSelectElement = document.getElementById('type-select');
            if (!typeSelectElement) return;
            
            typeSelectElement.innerHTML = '';
            
            // 遍历所有词库类型并添加到下拉框
            Object.keys(placeNameChars).forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeSelectElement.appendChild(option);
            });
            
            // 默认选择第一个类型
            if (typeSelectElement.options.length > 0) {
                typeSelectElement.selectedIndex = 0;
                changeType();
            }
        }
        
        // 初始化词库选择下拉框
        function initLibrarySelect() {
            const selectElement = document.getElementById('library-select');
            if (!selectElement) return;
            
            selectElement.innerHTML = '';
            
            // 遍历所有词库并添加到下拉框
            Object.keys(placeNameChars).forEach(category => {
                const categoryOption = document.createElement('option');
                categoryOption.value = category;
                categoryOption.textContent = `--- ${category} ---`;
                categoryOption.disabled = true;
                selectElement.appendChild(categoryOption);
                
                const libraries = placeNameChars[category];
                if (libraries && typeof libraries === 'object') {
                    Object.keys(libraries).forEach(libraryName => {
                        const option = document.createElement('option');
                        option.value = `${category}/${libraryName}`;
                        option.textContent = libraryName;
                        selectElement.appendChild(option);
                    });
                }
            });
            
            // 默认选择第一个可用词库
            if (selectElement.options.length > 0) {
                for (let i = 0; i < selectElement.options.length; i++) {
                    if (!selectElement.options[i].disabled) {
                        selectElement.selectedIndex = i;
                        break;
                    }
                }
                changeLibrary();
            }
        }
        
        // 切换词库类型
        function changeType() {
            const typeSelectElement = document.getElementById('type-select');
            const librariesListElement = document.getElementById('type-libraries-list');
            if (!typeSelectElement || !librariesListElement) return;
            
            const selectedType = typeSelectElement.value;
            if (!selectedType || !placeNameChars[selectedType]) return;
            
            // 清空词库列表
            librariesListElement.innerHTML = '';
            
            // 获取该类型下的所有词库
            const libraries = placeNameChars[selectedType];
            const libraryNames = libraries ? Object.keys(libraries) : [];
            
            if (libraryNames.length === 0) {
                librariesListElement.innerHTML = '<p style="margin: 0; color: var(--text-secondary);">该类型下暂无词库</p>';
                return;
            }
            
            // 生成词库列表
            libraryNames.forEach(libraryName => {
                const libraryItem = document.createElement('div');
                libraryItem.style.display = 'flex';
                libraryItem.style.alignItems = 'center';
                libraryItem.style.padding = '5px 10px';
                libraryItem.style.backgroundColor = 'var(--border-color)';
                libraryItem.style.borderRadius = '4px';
                libraryItem.style.marginRight = '10px';
                libraryItem.style.marginBottom = '10px';
                
                const libraryNameSpan = document.createElement('span');
                libraryNameSpan.textContent = libraryName;
                libraryNameSpan.style.marginRight = '8px';
                
                const removeButton = document.createElement('button');
                removeButton.textContent = '×';
                removeButton.style.background = 'none';
                removeButton.style.border = 'none';
                removeButton.style.cursor = 'pointer';
                removeButton.style.fontSize = '16px';
                removeButton.style.color = 'var(--text-secondary)';
                removeButton.style.padding = '0 4px';
                removeButton.style.borderRadius = '3px';
                removeButton.style.transition = 'background-color 0.2s';
                removeButton.onmouseover = function() {
                    removeButton.style.backgroundColor = 'rgba(231, 76, 60, 0.1)';
                    removeButton.style.color = 'var(--btn-danger-bg)';
                };
                removeButton.onmouseout = function() {
                    removeButton.style.backgroundColor = 'transparent';
                    removeButton.style.color = 'var(--text-secondary)';
                };
                removeButton.onclick = function() {
                    // 确保"未分类"类型存在
                    if (!placeNameChars['未分类']) {
                        placeNameChars['未分类'] = {};
                    }
                    
                    // 保存当前选择的类型
                    const currentType = selectedType;
                    
                    // 确保当前类型和词库存在
                    if (placeNameChars[selectedType] && placeNameChars[selectedType][libraryName]) {
                        // 将词库移动到"未分类"类型
                        placeNameChars['未分类'][libraryName] = [...placeNameChars[selectedType][libraryName]];
                        // 从原类型中删除词库
                        delete placeNameChars[selectedType][libraryName];
                        // 保存到本地存储
                        saveLibrariesToLocalStorage();
                        // 重新加载词库列表
                        changeType();
                        // 重新初始化词库选择下拉框
                        initLibrarySelect();
                        // 保持当前类型选择
                        const typeSelectElement = document.getElementById('type-select');
                        if (typeSelectElement) {
                            // 重新填充类型选项
                            typeSelectElement.innerHTML = '';
                            Object.keys(placeNameChars).forEach(type => {
                                const option = document.createElement('option');
                                option.value = type;
                                option.textContent = type;
                                typeSelectElement.appendChild(option);
                            });
                            // 设置回之前选择的类型
                            if (placeNameChars[currentType]) {
                                typeSelectElement.value = currentType;
                            }
                            // 重新加载词库列表
                            changeType();
                        }
                    }
                };
                
                libraryItem.appendChild(libraryNameSpan);
                libraryItem.appendChild(removeButton);
                librariesListElement.appendChild(libraryItem);
            });
        }
        
        // 切换词库
        function changeLibrary() {
            const selectElement = document.getElementById('library-select');
            const textareaElement = document.getElementById('library-textarea');
            
            if (!selectElement || !textareaElement) return;
            
            const selectedValue = selectElement.value;
            if (!selectedValue) return;
            
            // 解析选择的值，格式为 "category/library"
            const [category, libraryName] = selectedValue.split('/');
            if (!category || !libraryName) return;
            
            const charArray = placeNameChars[category][libraryName] || [];
            textareaElement.value = charArray.join(' ');
        }
        
        // 保存字库更改
        function saveLibraryChanges() {
            const selectElement = document.getElementById('library-select');
            const textareaElement = document.getElementById('library-textarea');
            
            if (!selectElement || !textareaElement) return;
            
            const selectedValue = selectElement.value;
            if (!selectedValue) return;
            
            // 解析选择的值，格式为 "category/library"
            const [category, libraryName] = selectedValue.split('/');
            if (!category || !libraryName) return;
            
            // 从文本框中读取词库内容
            const content = textareaElement.value;
            // 解析字符，支持空格和换行分隔
            const charArray = content.split(/\s+/).filter(char => char);
            
            // 更新词库
            placeNameChars[category][libraryName] = charArray;
            
            // 保存词库到本地存储
            saveLibrariesToLocalStorage();
            
            // 更新字符输入框，确保复选框状态正确
            updateCharacterInputs();
            
            // 显示保存成功的消息
            alert('词库更改已保存');
        }
        
        // 新增词库
        function addNewLibrary() {
            const libraryName = prompt('请输入新词库名称：');
            if (!libraryName) return;
            
            // 让用户选择词库分类
            const categories = ['单字', '双字词', '三字词', '四字词'];
            const category = prompt(`请选择词库分类：\n${categories.map((c, i) => `${i + 1}. ${c}`).join('\n')}\n\n请输入数字选择分类：`, '1');
            
            let selectedCategory;
            switch(category) {
                case '1':
                    selectedCategory = '单字';
                    break;
                case '2':
                    selectedCategory = '双字词';
                    break;
                case '3':
                    selectedCategory = '三字词';
                    break;
                case '4':
                    selectedCategory = '四字词';
                    break;
                default:
                    selectedCategory = '单字'; // 默认分类
            }
            
            // 检查词库名称是否已存在
            if (!placeNameChars[selectedCategory][libraryName]) {
                placeNameChars[selectedCategory][libraryName] = [];
                
                // 保存词库到本地存储
                saveLibrariesToLocalStorage();
                
                // 重新初始化词库选择下拉框
                initLibrarySelect();
                // 更新字符输入框，确保复选框状态正确
                updateCharacterInputs();
                alert(`新词库已添加到${selectedCategory}分类`);
            } else {
                alert('词库名称已存在');
            }
        }
        
        // 重命名词库
        function renameLibrary() {
            const selectElement = document.getElementById('library-select');
            if (!selectElement) return;
            
            const selectedValue = selectElement.value;
            if (!selectedValue) return;
            
            // 解析选择的值，格式为 "category/library"
            const [category, oldLibraryName] = selectedValue.split('/');
            if (!category || !oldLibraryName) return;
            
            const newLibraryName = prompt('请输入新词库名称：', oldLibraryName);
            if (!newLibraryName || newLibraryName === oldLibraryName) return;
            
            if (!placeNameChars[category][newLibraryName]) {
                // 复制旧词库内容到新词库
                placeNameChars[category][newLibraryName] = [...placeNameChars[category][oldLibraryName]];
                // 删除旧词库
                delete placeNameChars[category][oldLibraryName];
                
                // 保存词库到本地存储
                saveLibrariesToLocalStorage();
                
                // 重新初始化词库选择下拉框
                initLibrarySelect();
                // 更新字符输入框，确保复选框状态正确
                updateCharacterInputs();
                alert('词库已重命名');
            } else {
                alert('新词库名称已存在');
            }
        }
        
        // 删除词库
        function deleteLibrary() {
            const selectElement = document.getElementById('library-select');
            if (!selectElement) return;
            
            const selectedValue = selectElement.value;
            if (!selectedValue) return;
            
            // 解析选择的值，格式为 "category/library"
            const [category, libraryName] = selectedValue.split('/');
            if (!category || !libraryName) return;
            
            // 确认删除
            if (confirm(`确定要删除词库 "${libraryName}" 吗？`)) {
                // 删除词库
                delete placeNameChars[category][libraryName];
                
                // 保存词库到本地存储
                saveLibrariesToLocalStorage();
                
                // 重新初始化词库选择下拉框
                initLibrarySelect();
                // 更新字符输入框，确保复选框状态正确
                updateCharacterInputs();
                alert('词库已删除');
            }
        }
        
        // 导入词库
        function importLibrary() {
            // 直接打开文件选择，不先显示分类选择
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.txt';
            input.multiple = true;
            
            input.onchange = function(e) {
                const files = e.target.files;
                if (!files.length) return;
                
                let importedCount = 0;
                let mergedImportCount = 0;
                
                for (let file of files) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const content = e.target.result;
                            
                            // 检查是否为合并词库文件
                            if (content.includes('[')) {
                                // 处理合并词库文件
                                const libraries = parseMergedLibraryFile(content);
                                libraries.forEach(library => {
                                    const { category, name, chars } = library;
                                    // 确保分类存在
                                    if (!placeNameChars[category]) {
                                        placeNameChars[category] = {};
                                    }
                                    placeNameChars[category][name] = chars;
                                    mergedImportCount++;
                                });
                            } else {
                                // 处理单个词库文件，需要选择分类
                                showCategorySelectionForSingleLibrary(file, content);
                            }
                            
                            // 检查是否所有文件都处理完成（仅针对合并文件）
                            if (content.includes('[')) {
                                importedCount++;
                                if (importedCount === files.length) {
                                    // 保存词库到本地存储
                                    saveLibrariesToLocalStorage();
                                    
                                    // 重新初始化词库选择下拉框
                                    initLibrarySelect();
                                    // 更新字符输入框，确保复选框状态正确
                                    updateCharacterInputs();
                                    alert(`成功导入 ${mergedImportCount} 个词库`);
                                }
                            }
                        } catch (error) {
                            console.error('导入词库失败:', error);
                            alert('导入词库失败，请检查文件格式');
                        }
                    };
                    reader.readAsText(file, 'utf-8');
                }
            };
            
            input.click();
        }
        
        // 为单个词库文件显示分类选择
        function showCategorySelectionForSingleLibrary(file, content) {
            // 创建选择分类弹窗
            let modal = document.getElementById('import-category-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'import-category-modal';
                modal.className = 'library-modal';
                document.body.appendChild(modal);
            }
            
            // 生成分类选择界面
            const categories = ['单字', '双字词', '三字词', '四字词'];
            let categoriesHTML = '';
            categories.forEach(category => {
                categoriesHTML += `
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <input type="radio" name="import-category" value="${category}" style="transform: scale(1.2); margin-right: 10px;">
                        <label for="import-${category}" style="font-size: 14px; cursor: pointer; color: var(--text-color); transition: color 0.3s ease;">${category}</label>
                    </div>
                `;
            });
            
            modal.innerHTML = `
                <div class="library-modal-content" style="max-width: 500px;">
                    <div class="library-modal-header">
                        <h3>选择导入分类</h3>
                        <button class="btn btn-secondary" onclick="closeImportModal()" style="font-size: 24px; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">&times;</button>
                    </div>
                    <div class="library-content" style="max-height: 300px; overflow-y: auto;">
                        <p style="margin-bottom: 15px; font-size: 14px; color: var(--text-color); transition: color 0.3s ease;">请选择要导入词库的分类：</p>
                        <div style="background-color: var(--card-bg); padding: 15px; border-radius: 5px; border: 1px solid var(--border-color); transition: background-color 0.3s ease, border-color 0.3s ease;">
                            ${categoriesHTML}
                        </div>
                    </div>
                    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="closeImportModal()">取消</button>
                        <button class="btn btn-primary" onclick="confirmImportSingleLibrary('${file.name}', '${content.replace(/'/g, "\\'")}')">确认选择</button>
                    </div>
                </div>
            `;
            
            // 显示弹窗
            modal.style.display = 'block';
        }
        
        // 确认导入单个词库
        function confirmImportSingleLibrary(fileName, content) {
            const modal = document.getElementById('import-category-modal');
            if (!modal) return;
            
            // 获取选中的分类
            const selectedRadio = modal.querySelector('input[name="import-category"]:checked');
            if (!selectedRadio) {
                alert('请选择一个分类');
                return;
            }
            
            const selectedCategory = selectedRadio.value;
            
            // 关闭分类选择弹窗
            modal.style.display = 'none';
            
            try {
                const charArray = content.split(/\s+/).filter(char => char);
                // 使用文件名作为词库名称（去除扩展名）
                const libraryName = fileName.replace(/\.txt$/i, '');
                // 确保分类存在
                if (!placeNameChars[selectedCategory]) {
                    placeNameChars[selectedCategory] = {};
                }
                // 添加到用户选择的分类
                placeNameChars[selectedCategory][libraryName] = charArray;
                
                // 重新初始化词库选择下拉框
                initLibrarySelect();
                // 更新字符输入框，确保复选框状态正确
                updateCharacterInputs();
                alert(`成功导入词库 "${libraryName}" 到${selectedCategory}分类`);
            } catch (error) {
                console.error('导入词库失败:', error);
                alert('导入词库失败，请检查文件格式');
            }
        }
        
        function closeImportModal() {
            const modal = document.getElementById('import-category-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function confirmImportCategory() {
            const modal = document.getElementById('import-category-modal');
            if (!modal) return;
            
            // 获取选中的分类
            const selectedRadio = modal.querySelector('input[name="import-category"]:checked');
            if (!selectedRadio) {
                alert('请选择一个分类');
                return;
            }
            
            const selectedCategory = selectedRadio.value;
            
            // 关闭分类选择弹窗
            modal.style.display = 'none';
            
            // 打开文件选择
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.txt';
            input.multiple = true;
            
            input.onchange = function(e) {
                const files = e.target.files;
                if (!files.length) return;
                
                let importedCount = 0;
                let mergedImportCount = 0;
                
                for (let file of files) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const content = e.target.result;
                            
                            // 检查是否为合并词库文件
                            if (content.includes('[')) {
                                // 处理合并词库文件
                                const libraries = parseMergedLibraryFile(content);
                                libraries.forEach(library => {
                                    const { category, name, chars } = library;
                                    placeNameChars[category][name] = chars;
                                    mergedImportCount++;
                                });
                            } else {
                                // 处理单个词库文件
                                const charArray = content.split(/\s+/).filter(char => char);
                                // 使用文件名作为词库名称（去除扩展名）
                                const fileName = file.name.replace(/\.txt$/i, '');
                                // 添加到用户选择的分类
                                placeNameChars[selectedCategory][fileName] = charArray;
                                importedCount++;
                            }
                            
                            // 检查是否所有文件都处理完成
                                const totalProcessed = importedCount + mergedImportCount;
                                if (totalProcessed === files.length) {
                                    // 保存词库到本地存储
                                    saveLibrariesToLocalStorage();
                                    
                                    // 重新初始化词库选择下拉框
                                    initLibrarySelect();
                                    // 更新字符输入框，确保复选框状态正确
                                    updateCharacterInputs();
                                    alert(`成功导入 ${totalProcessed} 个词库`);
                                }
                        } catch (error) {
                            console.error('导入词库失败:', error);
                            alert('导入词库失败，请检查文件格式');
                        }
                    };
                    reader.readAsText(file, 'utf-8');
                }
            };
            
            input.click();
        }
        
        // 解析合并词库文件
        function parseMergedLibraryFile(content) {
            const libraries = [];
            const lines = content.split('\n');
            
            let currentCategory = '';
            let currentName = '';
            let currentChars = [];
            
            lines.forEach(line => {
                line = line.trim();
                
                // 检查是否为词库标记行
                if (line.startsWith('[') && line.endsWith(']')) {
                    // 保存之前的词库
                    if (currentCategory && currentName) {
                        libraries.push({
                            category: currentCategory,
                            name: currentName,
                            chars: currentChars
                        });
                    }
                    
                    // 解析新的词库标记
                    const match = line.match(/\[(.*?)\/(.*?)\]/);
                    if (match) {
                        currentCategory = match[1];
                        currentName = match[2];
                        currentChars = [];
                    }
                } else if (line && currentCategory && currentName) {
                    // 解析字符行
                    const chars = line.split(/\s+/).filter(char => char);
                    currentChars = currentChars.concat(chars);
                }
            });
            
            // 保存最后一个词库
            if (currentCategory && currentName) {
                libraries.push({
                    category: currentCategory,
                    name: currentName,
                    chars: currentChars
                });
            }
            
            return libraries;
        }
        
        // 导出词库
        function exportLibrary() {
            // 创建选择词库弹窗
            let modal = document.getElementById('export-library-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'export-library-modal';
                modal.className = 'library-modal';
                document.body.appendChild(modal);
            }
            
            // 生成词库选择界面
            let checkboxesHTML = '';
            
            // 遍历所有分类和词库
            Object.entries(placeNameChars).forEach(([category, libraries]) => {
                checkboxesHTML += `<h5 style="margin-top: 15px; margin-bottom: 10px; color: var(--text-color); transition: color 0.3s ease;">${category}</h5>`;
                
                Object.keys(libraries).forEach(libraryName => {
                    checkboxesHTML += `
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <input type="checkbox" id="export-${category}-${libraryName}" value="${category}/${libraryName}" style="transform: scale(1.2); margin-right: 10px;">
                            <label for="export-${category}-${libraryName}" style="font-size: 14px; cursor: pointer; color: var(--text-color); transition: color 0.3s ease;">${libraryName}</label>
                        </div>
                    `;
                });
            });
            
            modal.innerHTML = `
                <div class="library-modal-content" style="max-width: 600px;">
                    <div class="library-modal-header">
                        <h3>选择要导出的词库</h3>
                        <button class="btn btn-secondary" onclick="closeExportModal()" style="font-size: 24px; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">&times;</button>
                    </div>
                    <div class="library-content" style="max-height: 400px; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <p style="margin: 0; font-size: 14px; color: var(--text-color); transition: color 0.3s ease;">请选择要导出的词库：</p>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn btn-primary" onclick="selectAllExportLibraries()" style="padding: 4px 10px; font-size: 12px;">全选</button>
                                <button class="btn btn-warning" onclick="invertExportLibraries()" style="padding: 4px 10px; font-size: 12px;">反选</button>
                                <button class="btn btn-danger" onclick="clearExportLibraries()" style="padding: 4px 10px; font-size: 12px;">清空</button>
                            </div>
                        </div>
                        <div style="background-color: var(--card-bg); padding: 15px; border-radius: 5px; border: 1px solid var(--border-color); transition: background-color 0.3s ease, border-color 0.3s ease;">
                            ${checkboxesHTML}
                        </div>
                    </div>
                    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="closeExportModal()">取消</button>
                        <button class="btn btn-primary" onclick="confirmExportLibraries()">确认导出</button>
                    </div>
                </div>
            `;
            
            // 显示弹窗
            modal.style.display = 'block';
        }
        
        function closeExportModal() {
            const modal = document.getElementById('export-library-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function selectAllExportLibraries() {
            const modal = document.getElementById('export-library-modal');
            if (!modal) return;
            
            const checkboxes = modal.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
        }
        
        function invertExportLibraries() {
            const modal = document.getElementById('export-library-modal');
            if (!modal) return;
            
            const checkboxes = modal.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = !checkbox.checked;
            });
        }
        
        function clearExportLibraries() {
            const modal = document.getElementById('export-library-modal');
            if (!modal) return;
            
            const checkboxes = modal.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }
        
        function confirmExportLibraries() {
            const modal = document.getElementById('export-library-modal');
            if (!modal) return;
            
            // 获取选中的词库
            const checkboxes = modal.querySelectorAll('input[type="checkbox"]:checked');
            const selectedLibraries = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedLibraries.length === 0) {
                alert('请至少选择一个词库');
                return;
            }
            
            // 询问用户是否合并导出
            if (confirm('是否将选中的词库合并为一个文件导出？\n\n取消则每个词库单独导出为一个文件')) {
                // 合并导出
                exportMergedLibraries(selectedLibraries);
            } else {
                // 单独导出每个选中的词库
                selectedLibraries.forEach(libraryPath => {
                    const [category, libraryName] = libraryPath.split('/');
                    if (!category || !libraryName) return;
                    
                    const charArray = placeNameChars[category][libraryName] || [];
                    const content = charArray.join(' ');
                    
                    // 创建Blob对象
                    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    
                    // 创建下载链接
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${libraryName}.txt`;
                    link.click();
                    
                    // 释放URL
                    setTimeout(() => {
                        URL.revokeObjectURL(url);
                    }, 100);
                });
                
                alert(`成功导出 ${selectedLibraries.length} 个词库`);
            }
            
            // 关闭弹窗
            modal.style.display = 'none';
        }
        
        // 合并导出词库
        function exportMergedLibraries(selectedLibraries) {
            let mergedContent = '';
            
            selectedLibraries.forEach(libraryPath => {
                const [category, libraryName] = libraryPath.split('/');
                if (!category || !libraryName) return;
                
                const charArray = placeNameChars[category][libraryName] || [];
                const content = charArray.join(' ');
                
                // 格式：[分类/词库名]
                // 字符1 字符2 字符3...
                mergedContent += `[${category}/${libraryName}]\n${content}\n\n`;
            });
            
            // 创建Blob对象
            const blob = new Blob([mergedContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            // 创建下载链接
            const link = document.createElement('a');
            link.href = url;
            link.download = `merged_libraries_${new Date().toISOString().slice(0,10)}.txt`;
            link.click();
            
            // 释放URL
            setTimeout(() => {
                URL.revokeObjectURL(url);
            }, 100);
            
            alert(`成功将 ${selectedLibraries.length} 个词库合并导出为一个文件`);
        }
        
        // 更新词库文本框
        function updateLibraryTextarea() {
            const textarea = document.getElementById('library-textarea');
            if (!textarea) return;
            
            // 自动调整文本框高度以适应内容
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 500) + 'px';
        }
        
        // 切换主题模式
        function toggleTheme() {
            const body = document.body;
            const themeToggleBtn = document.getElementById('theme-toggle');
            
            // 切换暗色模式类
            body.classList.toggle('dark-mode');
            
            // 更新按钮图标
            if (body.classList.contains('dark-mode')) {
                themeToggleBtn.textContent = '☾';
                // 保存主题偏好到本地存储
                localStorage.setItem('theme', 'dark');
            } else {
                themeToggleBtn.textContent = '☀';
                // 保存主题偏好到本地存储
                localStorage.setItem('theme', 'light');
            }
        }
        
        // 加载保存的主题偏好
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('theme');
            const body = document.body;
            const themeToggleBtn = document.getElementById('theme-toggle');
            
            if (savedTheme === 'dark' || (savedTheme === null && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                body.classList.add('dark-mode');
                if (themeToggleBtn) {
                    themeToggleBtn.textContent = '☾';
                }
            } else {
                body.classList.remove('dark-mode');
                if (themeToggleBtn) {
                    themeToggleBtn.textContent = '☀';
                }
            }
        }
        
        // 滚动到页面顶部
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
        
        // 滚动到页面底部
        function scrollToBottom() {
            window.scrollTo({
                top: document.body.scrollHeight,
                behavior: 'smooth'
            });
        }
        
        // 页面加载完成后初始化
        window.onload = function() {
            initPlaceNameChars();
            initCharacterInputs();
            updateGenerateCount();
            loadSavedTheme();
        };
    </script>
    <!-- 固定的功能按钮 -->
    <div style="position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 999;">
        <button id="scroll-top-btn" onclick="scrollToTop()" class="btn btn-secondary" style="padding: 10px; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
            ↑
        </button>
        <button id="scroll-bottom-btn" onclick="scrollToBottom()" class="btn btn-secondary" style="padding: 10px; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
            ↓
        </button>
        <button id="theme-toggle" onclick="toggleTheme()" class="btn btn-secondary" style="padding: 10px; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
            ☀
        </button>
    </div>
    
    <footer style="text-align: center; margin-top: 30px; padding: 20px; background-color: var(--footer-bg); border-top: 1px solid var(--border-color); transition: background-color 0.3s ease, border-color 0.3s ease;">
        <div style="display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 15px;">
            <p>项目源码：<a href="https://github.com/Shomota/name-generator" target="_blank" style="color: var(--text-color); transition: color 0.3s ease;">GitHub</a></p>
        </div>
    </footer>
</body>
</html>